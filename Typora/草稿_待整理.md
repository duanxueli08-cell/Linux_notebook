

------

## ä¸€ã€ Helm å­¦ä¹ çš„æ¡†æž¶ä½“ç³»

ä½ å¯ä»¥æŒ‰ç…§è¿™å››ä¸ªç»´åº¦æ¥æž„å»ºä½ çš„çŸ¥è¯†å¤§è„‘ï¼š

### 1. æ ¸å¿ƒæ¦‚å¿µï¼ˆé“ä¸‰è§’ï¼‰

- **Chart**ï¼šè½¯ä»¶åŒ…ã€‚åŒ…å«äº†ä¸€ç»„ K8s èµ„æºå®šä¹‰çš„ç›®å½•ï¼ˆå°±åƒ RPM åŒ…ï¼‰ã€‚
- **Release**ï¼šè¿è¡Œå®žä¾‹ã€‚ä¸€ä¸ª Chart åœ¨é›†ç¾¤é‡Œæ¯å®‰è£…ä¸€æ¬¡ï¼Œå°±äº§ç”Ÿä¸€ä¸ª Releaseï¼ˆæ¯”å¦‚ä½ åœ¨ `dev` å’Œ `prod` å‘½åç©ºé—´å„è£…ä¸€ä¸ª Nginxï¼Œå°±æ˜¯ä¸¤ä¸ª Releaseï¼‰ã€‚
- **Repository**ï¼šä»“åº“ã€‚å­˜æ”¾ Chart çš„åœ°æ–¹ï¼ˆç±»ä¼¼ Docker Hub æˆ– Yum æºï¼‰ã€‚

### 2. Helm æž¶æž„æ¼”è¿›ï¼ˆé¿å‘æŒ‡å—ï¼‰

- **Helm v2 vs v3**ï¼šé‡ç‚¹çœ‹ v3ã€‚v3 å½»åº•å¹²æŽ‰äº†æœåŠ¡ç«¯ç»„ä»¶ **Tiller**ï¼Œç›´æŽ¥åˆ©ç”¨ `kubeconfig` çš„æƒé™ã€‚ä½ é¢è¯•æ—¶è¦æ˜¯æåˆ° v3 ç§»é™¤äº† Tiller æé«˜äº†å®‰å…¨æ€§ï¼Œé¢è¯•å®˜ä¼šè§‰å¾—ä½ å¾ˆæ‡‚ã€‚

### 3. Chart ç›®å½•ç»“æž„ï¼ˆè§£å‰–æ‰‹æœ¯ï¼‰

ä½ è¦å¯¹ `helm create` å‡ºæ¥çš„é‚£ä¸ªæ–‡ä»¶å¤¹äº†å¦‚æŒ‡æŽŒï¼š

- `Chart.yaml`ï¼šåŒ…çš„å…ƒæ•°æ®ï¼ˆåå­—ã€ç‰ˆæœ¬ï¼‰ã€‚
- `values.yaml`ï¼šå˜é‡æ–‡ä»¶ï¼ˆæ ¸å¿ƒï¼æ‰€æœ‰çŽ¯å¢ƒå·®å¼‚éƒ½å†™è¿™å„¿ï¼‰ã€‚
- `templates/`ï¼šYAML æ¨¡æ¿æ–‡ä»¶å¤¹ï¼ˆé‡Œé¢å…¨æ˜¯å¸¦ `{{ .Values.xxx }}` çš„å ä½ç¬¦ï¼‰ã€‚
- `charts/`ï¼šä¾èµ–çš„å…¶ä»– Chartã€‚

### 4. æ“ä½œæŒ‡ä»¤ï¼ˆç”Ÿå­˜æŠ€èƒ½ï¼‰

- åŸºç¡€å¢žåˆ æ”¹æŸ¥ï¼š`install`, `upgrade`, `rollback`, `uninstall`, `list`ã€‚
- è°ƒè¯•ç¥žæŠ€ï¼š`helm install --dry-run --debug`ï¼ˆæ¨¡æ‹Ÿå®‰è£…ï¼Œä¸å‘ç»™é›†ç¾¤ï¼Œåªçœ‹ç”Ÿæˆçš„ YAML å¯¹ä¸å¯¹ï¼ŒSRE å¿…å¤‡ï¼‰ã€‚

------

## äºŒã€ å­¦ä¹ å†…å®¹çš„é‡éš¾ç‚¹ï¼ˆé¢è¯•å¸¸è€ƒï¼‰

### 1. Go Template è¯­æ³•ï¼ˆé‡ç‚¹ & éš¾ç‚¹ï¼‰

è¿™æ˜¯ Helm çš„çµé­‚ã€‚ä½ éœ€è¦æŽŒæ¡å¦‚ä½•åœ¨ YAML é‡Œå†™é€»è¾‘ï¼š

- **å˜é‡å¼•ç”¨**ï¼š`{{ .Values.image.tag }}`
- **æŽ§åˆ¶æµ**ï¼š`if-else` åˆ¤æ–­ï¼Œ`range` å¾ªçŽ¯ã€‚
- **ç®¡é“ç¬¦ & å‡½æ•°**ï¼šæ¯”å¦‚ `quote`, `default`, `upper`ï¼Œä»¥åŠæœ€å¸¸ç”¨çš„ `indent`ï¼ˆæŽ§åˆ¶ç¼©è¿›ï¼ŒYAML çš„å‘½é—¨ï¼‰ã€‚

### 2. ä¾èµ–ç®¡ç†ï¼ˆDependency Managementï¼‰

å½“ä½ çš„é¡¹ç›®å¤æ‚åˆ°â€œå¤§åŒ…å¥—å°åŒ…â€æ—¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªå•†åŸŽç³»ç»Ÿä¾èµ– Redis å’Œ MySQLï¼‰ï¼Œå¦‚ä½•ç®¡ç† `Chart.yaml` é‡Œçš„ `dependencies`ã€‚

### 3. é’©å­æœºåˆ¶ï¼ˆHooksï¼‰

SRE åœ¨åšè‡ªåŠ¨åŒ–è¿ç»´æ—¶éžå¸¸ä¾èµ–è¿™ä¸ªã€‚æ¯”å¦‚ï¼šåœ¨å®‰è£… App ä¹‹å‰ï¼Œå…ˆè¿è¡Œä¸€ä¸ª Job åŽ»åˆå§‹åŒ–æ•°æ®åº“ã€‚

- æŽŒæ¡ `pre-install`, `post-upgrade` ç­‰é’©å­çš„ç”¨æ³•ã€‚

### 4. Chart çš„ç”Ÿå‘½å‘¨æœŸä¸Žç‰ˆæœ¬æŽ§åˆ¶

- **App Version**ï¼ˆç¨‹åºç‰ˆæœ¬ï¼‰ vs **Chart Version**ï¼ˆåŒ…ç‰ˆæœ¬ï¼‰çš„åŒºåˆ«ã€‚
- å¦‚ä½•å®žçŽ°ç°åº¦å‘å¸ƒæˆ–ä¸€é”®å›žæ»šã€‚

------

## æ€»ç»“

æ€»ç»“ä¸€å¥è¯ï¼šHelm å°±åƒæ˜¯æŠŠæ‚ä¹±çš„ YAML æ‰æˆäº†ä¸€ä¸ªå¸¦æœ‰å¼€å…³ï¼ˆValuesï¼‰çš„é»‘ç›’å­ï¼Œä½ çš„ä»»åŠ¡å°±æ˜¯å­¦ä¼šå¦‚ä½•é€ è¿™ä¸ªç›’å­ï¼Œä»¥åŠå¦‚ä½•ä¼˜é›…åœ°æŒ‰åŠ¨é‚£äº›å¼€å…³ã€‚

## å»ºè®®

**ä»Žâ€œæ”¹â€å¼€å§‹**ï¼šåŽ» **Artifact Hub** ä¸‹è½½ä¸€ä¸ªå®˜æ–¹çš„ Redis æˆ– Nginx Chartï¼Œæ‹†è§£å®ƒçš„ `templates`ï¼Œçœ‹å¤§ç‰›æ˜¯æ€Žä¹ˆå†™æ¨¡æ¿çš„ã€‚

**ä¸è¦åªå­¦ Helm**ï¼šHelm æ˜¯â€œæ‰“åŒ…â€ï¼Œä½†çŽ°åœ¨çš„è¶‹åŠ¿æ˜¯ **GitOps**ï¼ˆæ¯”å¦‚ ArgoCDï¼‰ã€‚ç­‰ä½ æŠŠ Helm çŽ©ç†Ÿäº†ï¼Œä¸€å®šè¦çœ‹çœ‹æ€Žä¹ˆç”¨ GitOps æ¥é©±åŠ¨ Helm çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

GitOps çš„æµè¡Œæœ¬è´¨ä¸Šæ˜¯å› ä¸º **K8s çš„å£°æ˜Žå¼ API** å¤ªå¼ºå¤§äº†ï¼Œè€Œ Git åˆæ˜¯ç¨‹åºå‘˜æœ€ç†Ÿæ‚‰çš„å·¥å…·ï¼Œä¸¤è€…ä¸€ç»“åˆï¼Œç®€ç›´æ˜¯â€œé‡‘é£ŽçŽ‰éœ²ä¸€ç›¸é€¢â€ã€‚





## å®‰å…¨

å®‰å…¨ä½“ç³»

- è®¤è¯ï¼›
- æŽˆæƒï¼›
- å‡†å…¥æŽ§åˆ¶ï¼›

åœ¨Kubernetesé›†ç¾¤ä¸­å®šä¹‰äº†ä¸¤ç§ç±»åž‹çš„subjectèµ„æºçš„è®¤è¯ç”¨æˆ·ï¼š

User Account ï¼Œç®€ç§°ï¼šUAï¼›ç”¨æˆ·è´¦æˆ·ï¼ŒæŒ‡éžPodç±»çš„å®¢æˆ·ç«¯è®¿é—®API Serveræ—¶ä½¿ç”¨çš„èº«ä»½æ ‡è¯†ï¼Œæ˜¯çŽ°å®žä¸­çš„â€œäººâ€

- k8s é›†ç¾¤ä¸­æ²¡æœ‰è¿™ç§èµ„æºï¼›
- åŸºäºŽ X509 è¯ä¹¦æ–‡ä»¶æˆ–è€… token ä»¤ç‰Œåˆ›å»ºè´¦å·ï¼›
- ç»™äººä½¿ç”¨çš„ï¼›

Service Accountï¼Œç®€ç§°ï¼šSAï¼›æœåŠ¡è´¦æˆ·ï¼Œé€‚ç”¨äºŽé›†ç¾¤ä¸­Podå†…çš„è¿›ç¨‹è®¿é—®API Server æ—¶ä½¿ç”¨çš„èº«ä»½ä¿¡æ¯ï¼Œéœ€è¦é€šè¿‡ API æ¥å®Œæˆæƒé™è®¤è¯

- k8s é›†ç¾¤å†…éƒ¨çš„èµ„æºï¼›
- ç»™ pod æ˜¯ä½¿ç”¨çš„ï¼›
- é…åˆ secret ä½¿ç”¨

kubeconfig é…ç½®æ–‡ä»¶ ï¼ˆ ç±»ä¼¼äºŽ k8s é›†ç¾¤çš„ç®¡ç†å‘˜ï¼Œèƒ½çœ‹æ‡‚é…ç½®ä¿¡æ¯å°±è¡Œï¼ ï¼‰

- ç”¨æˆ·ï¼›
- é›†ç¾¤ï¼›
- contestï¼›
- current-contestï¼›

æŽˆæƒ â€”â€”â€”â€”> RBAC æŽˆæƒæœºåˆ¶

roleï¼šåŠ«è‰²ï¼Œæƒé™çš„é›†åˆï¼›

ruleï¼šèµ„æºåˆ†é…çš„æƒé™ç›¸å…³çš„è§„åˆ™ï¼›

- RoleBinding (ç©ºé—´ç»‘å®š)

  - åªèƒ½ç®¡ç†**å—é™äºŽå‘½åç©ºé—´çš„èµ„æº**ï¼ˆæ¯”å¦‚ Pod, Deployment, Serviceï¼‰

- ClusterRoleBinding (é›†ç¾¤ç»‘å®š)

  - ä¸ä»…èƒ½ç®¡ç†åç§°ç©ºé—´çš„èµ„æºï¼Œè€Œä¸”èƒ½ç®¡ç†é›†ç¾¤çº§åˆ«çš„èµ„æº ï¼ˆæ¯”å¦‚ **Nodes (ç‰©ç†èŠ‚ç‚¹)**ã€**PersistentVolumes (å­˜å‚¨å·)**ã€**Namespaces æœ¬èº«**ï¼‰

- æ··åˆç»‘å®š

  - ClusterRole + RoleBinding  æŠŠå…¨å±€å®šä¹‰çš„æ¨¡æ¿ï¼Œåº”ç”¨åœ¨å±€éƒ¨ç©ºé—´é‡Œï¼›

  - å†™ä¸€ä¸ª `ClusterRole` å« `common-read-only`ã€‚

    åœ¨ 50 ä¸ª Namespace é‡Œåˆ›å»º `RoleBinding` å¼•ç”¨å®ƒã€‚

    ä»¥åŽæƒ³åŠ æƒé™ï¼Ÿæ”¹ä¸€ä¸‹é‚£ä¸ª `ClusterRole`ï¼Œ50 ä¸ª Namespace çž¬é—´åŒæ­¥ç”Ÿæ•ˆï¼

bashborad è®¤è¯æŽˆæƒ

- token
- kubeconfig 

kuboard

- kubeconfig
- token









æŸ¥çœ‹ç”¨æˆ·ç»„ kubeadm:cluster-admins çš„æƒé™

```powershell
kubectl get nodes
diff /etc/kubernetes/admin.conf .kube/config
grep client-certificate-data .kube/config |awk '{print $NF}'|base64 -d | openssl x509 -noout -subject
# æ–°ç‰ˆï¼šæŸ¥çœ‹roleè§’è‰²cluster-adminåŒåçš„clusterrolebindingï¼Œåˆ†é…æƒé™ç»™kubeadm:cluster-adminsç»„
kubectl get clusterrolebinding kubeadm:cluster-admins -o yaml
```

æŸ¥çœ‹ç”¨æˆ·ç»„ system:masters çš„æƒé™

ä¸€èˆ¬éƒ½æ˜¯åˆ›å»ºå¤šä¸ªç”¨æˆ·ç»„ï¼Œå°†ä¸åŒçš„ç”¨æˆ·å½’ç±»ç”¨æˆ·ç»„ï¼Œä»¥æ­¤è¾¾åˆ°ç”¨æˆ·æƒé™ç®¡ç†çš„ç›®çš„ï¼›

æ‰€æœ‰çš„k8sé›†ç¾¤èµ„æºæ“ä½œï¼Œå…¶å®žéƒ½æ˜¯é€šè¿‡nodeèŠ‚ç‚¹ä¸Šçš„kubeletå’ŒmasterèŠ‚ç‚¹ä¸Šçš„apiserverä¹‹é—´çš„é€šä¿¡å®žçŽ°ï¼Œè€Œåœ¨kubernetesçš„è®¤è¯ç›®å½•ä¸­æœ‰å…¶ä¸“ç”¨çš„é€šä¿¡è®¤è¯è¯ä¹¦ apiserver-kubelet-client.crtï¼Œå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶æ¥æ£€æŸ¥ä¸€ä¸‹è¿™ä¸¤è€…ä¹‹é—´æ˜¯ä¸€ä¸ªæ€Žæ ·çš„å…³ç³»ã€‚

### è®¤è¯

> #### **æ¡ˆä¾‹: åˆ›å»ºåŸºäºŽ X509 å®¢æˆ·ç«¯ç”¨æˆ·è¯ä¹¦**

åŸºäºŽopenssl å‘½ä»¤åˆ›å»ºç®¡ç†è¯ä¹¦

```powershell
# åœ¨ master èŠ‚ç‚¹åˆ›å»º test ç”¨æˆ·è¯ä¹¦
mkdir pki
(umask 077; openssl genrsa -out pki/test.key 4096)
# ç”Ÿæˆè¯ä¹¦ç”³è¯· ï¼ˆ åŠ å…¥çš„ ops ç»„åªå…·æœ‰æ™®é€šæƒé™ ï¼‰
openssl req -new -key pki/test.key -out pki/test.csr -subj "/CN=test/O=ops"
# ä½¿ç”¨ kubernetes-ca é¢å‘è¯ä¹¦
openssl x509 -req -days 3650 -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -in pki/test.csr -out pki/test.crt
# æµ‹è¯•ï¼Œé€šè¿‡curlä½¿ç”¨è¯ä¹¦è®¿é—®ï¼Œä»æ˜¯æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®
curl --cert pki/test.crt --key pki/test.key --key-type PEM --cacert /etc/kubernetes/pki/ca.crt https://kubeapi.wang.org:6443
# é‡æ–°ç”Ÿæˆè¯ä¹¦ç”³è¯· ï¼ˆ è¿™æ¬¡åŠ å…¥ç®¡ç†å‘˜ç»„ ï¼‰
openssl req -new -key pki/test.key -out pki/test.csr -subj "/CN=test/O=kubeadm:cluster-admins"
# æµ‹è¯•
curl --cert pki/test.crt --key pki/test.key --key-type PEM --cacert /etc/kubernetes/pki/ca.crt https://kubeapi.wang.org:6443
```

> #### æ¡ˆä¾‹ï¼šä»¤ç‰Œ Token è®¤è¯

åŸºäºŽé™æ€ token ä»¤ç‰Œå‘ API Server æ·»åŠ è®¤è¯ç”¨æˆ·

```powershell
# å‡†å¤‡ Token æ–‡ä»¶å­˜æ”¾çš„ç‹¬ç«‹ç›®å½•
mkdir /etc/kubernetes/auth && cd /etc/kubernetes/auth
# åˆ›å»ºé™æ€ä»¤ç‰Œæ–‡ä»¶å¹¶æ·»åŠ ç”¨æˆ·ä¿¡æ¯
echo "$(openssl rand -hex 3).$(openssl rand -hex 8),wang,1001,system:masters" > /etc/kubernetes/auth/token.csv
echo "$(openssl rand -hex 3).$(openssl rand -hex 8),test,1002,dev" >> /etc/kubernetes/auth/token.csv

# ä¿®æ”¹ apiserver å¯åŠ¨åŠ è½½æ–‡ä»¶ ( æœ€å¥½åšä¸ªå¤‡ä»½ ) ( ä¸è¦å°†ä¸‹é¢çš„æ³¨é‡Šå¤åˆ¶è¿›åŽ» )
cp /etc/kubernetes/manifests/kube-apiserver.yaml /root/
vi /etc/kubernetes/manifests/kube-apiserver.yaml
spec:
  containers:
  - command:
    - kube-apiserver
    - --token-auth-file=/etc/kubernetes/auth/token.csv # åŠ ä¸€è¡Œï¼ŒæŒ‡å®šå‰é¢åˆ›å»ºæ–‡ä»¶çš„è·¯å¾„

  volumeMounts:o
    - mountPath: /etc/kubernetes/auth			# æ·»åŠ ä¸‰è¡Œ,å®žçŽ°æ•°æ®å·çš„æŒ‚è½½é…ç½®,æ³¨æ„ï¼šæ­¤å¤„æ˜¯ç›®å½•
      name: static-auth-token
      readOnly: true
ï¼š
  volumes:
  - hostPath: 						# æ·»åŠ å››è¡Œæ•°æ®å·å®šä¹‰
      path: /etc/kubernetes/auth 	# æ³¨æ„ï¼šæ­¤å¤„æ˜¯ç›®å½•
      type: DirectoryOrCreate
    name: static-auth-token
```

```powershell
ps aux | grep auth
# æŸ¥çœ‹ç”Ÿæˆçš„ token
cat /etc/kubernetes/auth/token.csv
# æµ‹è¯•-1
TOKEN="fd9745.e454c4f5f57bd54b";
curl -k -H "Authorization: Bearer $TOKEN" https://kubeapi.wang.org:6443 
# åœ¨ node èŠ‚ç‚¹æ‹¿åˆ° token å°±å¯ä»¥è®¿é—® kube apiserver äº†
TOKEN="1a2dab.6895748fd9e46182" 
kubectl -s "https://kubeapi.wang.org:6443" --token="$TOKEN" --certificate-authority=/etc/kubernetes/pki/ca.crt get pod -A
æˆ–è€…ä¸æŒ‡å®šè®¤è¯
kubectl -s "https://kubeapi.wang.org:6443" --token="$TOKEN" --insecure-skip-tls-verify=true get pod -A
```

```powershell
# å¯ä»¥çœ‹åˆ° kebectl æ˜¯ç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åº
ll /usr/bin/kubectl 
# ä¼ åˆ°é›†ç¾¤å¤–çš„ä¸»æœºä¸­
scp /usr/bin/kubectl 10.0.0.107:/usr/local/bin/
# è¿›å…¥ 107 è¿™ä¸ªä¸»æœºï¼›å®šä¹‰ token ï¼›
TOKEN="fd9745.e454c4f5f57bd54b";
kubectl -s "https://10.0.0.101:6443" --token="$TOKEN" --insecure-skip-tls-verify=true get pod -A
# ç”±æ­¤å¯ä»¥çœ‹å‡ºåœ¨ k8s é›†ç¾¤å¤–ç®¡ç† k8s é›†ç¾¤çš„å‰æ™¯ï¼Œå¹¶ä¸”å¯ä»¥å»¶ä¼¸åˆ°åœ¨ Windows ç³»ç»Ÿé€šè¿‡å›¾å½¢ç•Œé¢ç®¡ç† k8s é›†ç¾¤
# ç”¨æˆ·ä¸€å¤šï¼Œé‚£ä¹ˆè¯ä¹¦ã€token ç®¡ç†å°±æ˜¯éº»çƒ¦ï¼Œè¿™å°±ä¸å¾—ä¸è¯´ kubeconfig ç®¡ç†äº†ï¼
```



#### kubeconfig ç®¡ç†

`admin.conf` æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **Kubeconfig** æ–‡ä»¶ã€‚å®ƒå°±åƒæ˜¯ä½ è¿›å‡º K8s é›†ç¾¤çš„â€œé€šå…³æ–‡ç‰’â€å’Œâ€œç§é’¥å¤§ç¤¼åŒ…â€ã€‚`admin.conf` æ‹¥æœ‰é›†ç¾¤çš„ **æœ€é«˜æƒé™ï¼ˆRootï¼‰**

å½“ä½ æŠŠè¿™ä¸ªæ–‡ä»¶æ‹¿åˆ°ä»ŽèŠ‚ç‚¹ï¼Œæ‰§è¡Œ `kubectl` å‘½ä»¤æ—¶ï¼Œå®ƒä¼šè¯»å–è¿™äº›ä¿¡æ¯ï¼Œè¯æ˜Žâ€œæˆ‘æ˜¯è°â€ä»¥åŠâ€œæˆ‘è¦åŽ»å“ªâ€ï¼ŒAPI Server éªŒæ˜Žæ­£èº«ä¹‹åŽï¼Œå°±ä¼šæ”¾è¡Œã€‚



#### " è‚¢è§£ "  admin.conf  æ–‡ä»¶

- Clustersï¼ˆæˆ‘ä»¬è¦åŽ»å“ªå„¿ï¼Ÿï¼‰

```powershell
# è¿™ä¸€éƒ¨åˆ†å®šä¹‰äº†ä½ è¦è¿žæŽ¥çš„ç›®çš„åœ°ã€‚
clusters:
- cluster:
    certificate-authority-data: LS0t... # è¿™ä¸€å¤§æ®µæ˜¯ CA è¯ä¹¦
    server: https://kubeapi.wang.org:6443 # API Server çš„åœ°å€
  name: kubernetes
```

> -  **server**: è¿™æ˜¯æœ€å…³é”®çš„ã€‚å®ƒå‘Šè¯‰ `kubectl`ï¼šä½ è¦è®¿é—®çš„é›†ç¾¤â€œå¤§é—¨â€åœ¨ `kubeapi.wang.org` çš„ 6443 ç«¯å£ã€‚å¦‚æžœä½ åœ¨åŠžå…¬ç½‘çŽ¯å¢ƒï¼Œè¿™ä¸ªåŸŸåå¿…é¡»èƒ½è§£æžåˆ°ä½  Master èŠ‚ç‚¹çš„ IPï¼Œå¦åˆ™å°±ä¼šæŠ¥ `getsockopt: connection refused`ã€‚
> - **certificate-authority-data**: è¿™æ˜¯é›†ç¾¤ CA æ ¹è¯ä¹¦çš„ Base64 ç¼–ç ã€‚å®ƒçš„ä½œç”¨æ˜¯**â€œéªŒè¯æœåŠ¡å™¨â€**ã€‚å½“ä½ è®¿é—® API Server æ—¶ï¼Œ`kubectl` ä¼šç”¨è¿™æ®µæ•°æ®åŽ»éªŒè¯æœåŠ¡ç«¯ç»™å‡ºçš„è¯ä¹¦åˆä¸åˆæ³•ï¼Œé˜²æ­¢ä½ è¿žåˆ°äº†é»‘å®¢ä¼ªé€ çš„ API Server ä¸Šï¼ˆé˜²ä¸­é—´äººæ”»å‡»ï¼‰ã€‚

- Usersï¼ˆæˆ‘æ˜¯è°ï¼Ÿï¼‰

```powershell
# è¿™ä¸€éƒ¨åˆ†å®šä¹‰äº†ä½ çš„èº«ä»½è¯æ˜Žã€‚
users:
- name: kubernetes-admin
  user:
    client-certificate-data: LS0t... # å®¢æˆ·ç«¯è¯ä¹¦
    client-key-data: LS0t...         # å®¢æˆ·ç«¯ç§é’¥
```

> 1. **name**: å« `kubernetes-admin`ã€‚
> 2. **client-certificate-data**: ä½ çš„â€œèº«ä»½è¯â€ã€‚API Server æ‹¿åˆ°è¿™ä¸ªåŽï¼Œä¼šè§£å¯†çœ‹é‡Œé¢çš„å†…å®¹ã€‚
> 3. **é‡ç‚¹ï¼ˆç”¨æˆ·ç»„å’Œç”¨æˆ·ï¼‰**ï¼š è™½ç„¶ä½ åœ¨ YAML é‡Œçœ‹åˆ°åå­—å« `kubernetes-admin`ï¼Œä½† K8s å†…éƒ¨çœŸæ­£è¯†åˆ«ä½ æƒé™çš„ï¼Œæ˜¯**ç­¾å‘è¿™ä¸ªè¯ä¹¦æ—¶å†™è¿›é‡Œé¢çš„ CN (Common Name) å’Œ O (Organization)**ã€‚
>
> - ä½ å¯ä»¥è¯•ç€ç”¨è¿™ä¸ªå‘½ä»¤è§£ç çœ‹çœ‹ï¼ˆå‡å¦‚ä½ æŠŠé‚£æ®µ Base64 å­˜æˆæ–‡ä»¶ï¼‰ï¼š `echo "LS0t..." | base64 -d | openssl x509 -text -noout`
> - ä½ ä¼šå‘çŽ°è¿™ä¸ªè¯ä¹¦çš„ **Subject** é‡Œå†™ç€ï¼š`O = system:masters, CN = kubernetes-admin`ã€‚
> - **CN (kubernetes-admin)** å°±æ˜¯**ç”¨æˆ·å**ã€‚
> - **O (system:masters)** å°±æ˜¯**ç”¨æˆ·ç»„**ã€‚
> - **ä¸ºä»€ä¹ˆæƒé™è¿™ä¹ˆå¤§ï¼Ÿ** å› ä¸º K8s å†…ç½®äº†ä¸€ä¸ªé»˜è®¤çš„ RBAC ç­–ç•¥ï¼ˆClusterRoleBindingï¼‰ï¼ŒæŠŠ `system:masters` è¿™ä¸ªç»„ç»‘å®šåˆ°äº† `cluster-admin` è¿™ä¸ªæœ€é«˜æƒé™çš„è§’è‰²ä¸Šã€‚æ‰€ä»¥ï¼Œ**åªè¦ä½ æ‹¿ç€è¿™ä¸ªè¯ä¹¦ï¼Œä½ å°±æ˜¯é›†ç¾¤çš„ Rootã€‚**



- Contextsï¼ˆä¸Šä¸‹æ–‡ï¼šè¿žè¿žçœ‹ï¼‰

```powershell
# è¿™ä¸€éƒ¨åˆ†æ˜¯æŠŠä¸Šé¢çš„â€œç›®çš„åœ°â€å’Œâ€œèº«ä»½â€å…³è”èµ·æ¥ã€‚
contexts:
- context:
    cluster: kubernetes      # ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„åä¸º kubernetes çš„é›†ç¾¤
    user: kubernetes-admin   # ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„åä¸º kubernetes-admin çš„ç”¨æˆ·
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes # å½“å‰é»˜è®¤ä½¿ç”¨çš„çŽ¯å¢ƒ
```

> - **Context** å°±åƒæ˜¯ä¸€ä¸ªâ€œæ‹¨å·é…ç½®â€ã€‚ä½ å¯ä»¥å®šä¹‰å¾ˆå¤šä¸ª Contextï¼ˆæ¯”å¦‚ä¸€ä¸ªè¿žç”Ÿäº§çŽ¯å¢ƒï¼Œä¸€ä¸ªè¿žæµ‹è¯•çŽ¯å¢ƒï¼‰ï¼Œé€šè¿‡ `kubectl config use-context` åƒåˆ‡æ¢é¢‘é“ä¸€æ ·åœ¨ä¸åŒé›†ç¾¤é—´åˆ‡æ¢ã€‚
> - **current-context**: å†³å®šäº†å½“ä½ ç›´æŽ¥æ•² `kubectl get pod` æ—¶ï¼Œé»˜è®¤èµ°å“ªä¸ªé…ç½®ã€‚





```powershell
# ç”Ÿæˆ kubeconfig ç®¡ç†æ–‡ä»¶
kubectl config set-cluster myk8s --server=https://10.0.0.101:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt  --embed-certs=true --kubeconfig ./kubeconfig-test/mykube.conf && cat ./kubeconfig-test/mykube.conf
# ç¡®è®¤ä¹‹å‰åˆ›å»ºçš„ token ç”¨æˆ·ä¿¡æ¯
cat /etc/kubernetes/auth/token.csv
# å®šä¹‰User:æ·»åŠ èº«ä»½å‡­æ®ï¼Œä½¿ç”¨é™æ€ä»¤ç‰Œæ–‡ä»¶è®¤è¯çš„wangç”¨æˆ·çš„ä»¤ç‰Œä»¤ç‰Œ
TOKEN="fd9745.e454c4f5f57bd54b" 
kubectl config set-credentials wang --token="$TOKEN" --kubeconfig $HOME/kubeconfig-test/mykube.conf
cat $HOME/file/mykube.conf
# å®šä¹‰Context:ä¸ºç”¨æˆ·wangçš„èº«ä»½å‡­æ®ä¸Žkube-testé›†ç¾¤å»ºç«‹æ˜ å°„å…³ç³»
kubectl config set-context wang@myk8s --cluster=myk8s --user=wang --kubeconfig $HOME/kubeconfig-test/mykube.conf
cat $HOME/kubeconfig-test/mykube.conf

# æµ‹è¯•ï¼šå°†æ–‡ä»¶ä¼ åˆ° 107 ä¸»æœº
scp /root/kubeconfig-test/mykube.conf 10.0.0.107:/root
# è¿›å…¥ 107 ä¸»æœºè®¿é—® kube apiserver
kubectl config use-context wang@myk8s --kubeconfig /root/mykube.conf
# å°†æ–‡ä»¶æ”¾å…¥é»˜è®¤è·¯å¾„ä¸‹ï¼Œè¿™æ ·æ¯æ¬¡è®¿é—®å°±ä¸ç”¨æ‰‹åŠ¨æŒ‡å®šæ–‡ä»¶äº†
mkdir $HOME/.kube  ; cp $HOME/mykube.conf $HOME/.kube/config
# é€šè¿‡æŒ‡ä»¤æˆ–è€…ç¼–è¾‘æ–‡ä»¶ï¼Œå°†å¯¹åº”çš„ç”¨æˆ· myk8s è®¾ä¸ºé»˜è®¤å€¼
vi $HOME/.kube/config
current-contest: myk8s
# å¦‚æ­¤è¿™èˆ¬â€¦â€¦è¿™èˆ¬ï¼Œå°±å¯ä»¥è¿™æ ·äº†ï¼( å®žçŽ°å¹¶ç®¡ç† k8s é›†ç¾¤å¤–è®¿é—® k8s çš„ç”¨æˆ· )
kubectl get pod -A
```

```powershell
kubectl / helm / k9s â€”â€”â€”â€”> kubeconfig â€”â€”â€”â€”> api-server
```

ä»¥ä¸Šåˆ›å»ºçš„ç”¨æˆ·è´¦å·éƒ½æ˜¯ UA ï¼Œä¸ç®¡æ˜¯ cert æ–‡ä»¶è¿˜æ˜¯ token éƒ½ä¸æ˜¯ k8s çš„èµ„æºï¼Œéƒ½æ˜¯åœ¨ k8s ä¹‹å¤–åˆ›å»ºçš„ï¼Œæ˜¯ç»™äººç”¨çš„ï¼

 æ¯ä¸€ä¸ªåç§°ç©ºé—´éƒ½æœ‰ä¸€ä¸ª default çš„ SA è´¦å·ï¼›

åœ¨ deploy çš„ yaml æ–‡ä»¶ä¸­ spec.template.spec å­—æ®µä¸‹å¯ä»¥çœ‹åˆ° serviceAccountName: default ï¼Œè¿™ä¸ªå°±æ˜¯é»˜è®¤ SA è´¦å·ï¼Œè¿™ä¸ª SA è´¦å·åªæœ‰ä¸€èˆ¬æƒé™ï¼›

åˆ›å»º SA è´¦å·ï¼Œä¹Ÿæ˜¯åœ¨ spec.template.spec è¿™ä¸ªå­—æ®µä¸‹æ“ä½œï¼›

åˆ›å»º kubeconfig æ–‡ä»¶ï¼Œåªæ˜¯å…·å¤‡äº†è¿žæŽ¥ k8s é›†ç¾¤çš„èƒ½åŠ›ï¼Œä½†æ˜¯åŽç»­è¿˜æœ‰æŽˆæƒï¼





åˆ›å»º Role

```powershell
# å‘½ä»¤å¼å‘½ä»¤
kubectl create role NAME --verb=verb --resource=resource.group/subresource [--resource-name=resourcename]
verbï¼š						# å…è®¸åœ¨èµ„æºä¸Šä½¿ç”¨çš„æ“ä½œï¼ˆverbï¼‰åˆ—è¡¨
resources.group/subresourceï¼š# æ“ä½œå¯æ–½åŠ çš„ç›®æ ‡èµ„æºç±»åž‹æˆ–å­èµ„æºåˆ—è¡¨
resourcenameï¼š				# ç‰¹å®šçš„èµ„æºå¯¹è±¡åˆ—è¡¨ï¼Œå¯é€‰

# å‘½ä»¤åˆ›å»º role ï¼šåˆ›å»ºä¸€ä¸ªå¯¹æ‰€æœ‰pod,service,deploymentå…·æœ‰getã€listæƒé™çš„roleçš„èµ„æºå®šä¹‰æ–‡ä»¶æ ¼å¼
kubectl create role pods-viewer --verb=get,list,watch --resource=pods,services,deployments --dry-run=client -o yaml

```

verbs æ˜¯è¿ç»´æœ€å¸¸çœ‹çš„

| verb   | æ„ä¹‰   |
| ------ | ------ |
| get    | çœ‹ä¸€ä¸ª |
| list   | çœ‹ä¸€å † |
| watch  | ç›‘å¬   |
| create | åˆ›å»º   |
| update | æ›´æ–°   |
| patch  | å±€éƒ¨æ”¹ |
| delete | åˆ é™¤   |



æŸ¥çœ‹ç³»ç»Ÿå†…ç½® role

```powershell
kubectl get role -A
kubectl get role -n kube-system kubeadm:kubelet-config -o yaml

```

```powershell
åˆ›å»º role
kubectl create role pods-viewer \
  --verb=get,list,watch \
  --resource=pods,services,deployments \
  --namespace=dev \
  --dry-run=client -o yaml > role-pods-viewer.yaml
  
 ç»‘å®šç”¨æˆ·åˆ°æƒé™ï¼ˆRoleBindingï¼‰
 cat > rolebinding-wang.yaml <<'eof'
 apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wang-pod-reader
  namespace: dev
subjects:
- kind: User
  name: wang       # â† æ¥è‡ª token.csv æˆ–è¯ä¹¦ CN
  apiGroup: ""
roleRef:
  kind: Role
  name: pods-viewer
  apiGroup: rbac.authorization.k8s.io
eof

kubectl apply -f role-pods-viewer.yaml
kubectl apply -f rolebinding-wang.yaml
```







------

### âœ… æ–¹æ¡ˆï¼šä½¿ç”¨ `ClusterRole` + `RoleBinding`ï¼ˆæŽ¨èç”Ÿäº§æ–¹å¼ï¼‰

> ä¼˜åŠ¿ï¼š  
>
> - `ClusterRole` å¯è¢«å¤šä¸ªå‘½åç©ºé—´å¤ç”¨ï¼ˆä¾‹å¦‚ dev/staging/prod éƒ½å¯ç»‘å®šåŒä¸€ä¸ª ClusterRoleï¼‰  
> - æƒé™é›†ä¸­ç®¡ç†ï¼Œé¿å…é‡å¤å®šä¹‰ Role  
> - ç¬¦åˆæœ€å°æƒé™åŽŸåˆ™ï¼ˆé€šè¿‡ RoleBinding é™åˆ¶ä½œç”¨åŸŸï¼‰

------

#### 1. åˆ›å»º ClusterRoleï¼ˆé›†ç¾¤èŒƒå›´çš„è§’è‰²å®šä¹‰ï¼‰

```yaml
cat > clusterrole-pods-viewer.yaml <<'eof'
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pods-viewer-cluster  # å…¨å±€å”¯ä¸€åç§°
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch"]
eof
```

> ðŸ“Œ æ³¨æ„ï¼š
>
> - `ClusterRole` æ²¡æœ‰ `namespace` å­—æ®µï¼ˆå®ƒæ˜¯é›†ç¾¤çº§åˆ«çš„ï¼‰
> - èµ„æºåˆ†ç»„ï¼š`pods/services` å±žäºŽæ ¸å¿ƒ API ç»„ï¼ˆ`""`ï¼‰ï¼Œ`deployments` å±žäºŽ `apps` ç»„

------

#### 2. åœ¨ `dev` å‘½åç©ºé—´ä¸­åˆ›å»º RoleBindingï¼Œç»‘å®šç”¨æˆ·åˆ°è¯¥ ClusterRole

```yaml
cat > rolebinding-wang-dev.yaml <<'eof'
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: wang-pods-reader-in-dev
  namespace: dev  # â† æƒé™ä»…åœ¨æ­¤å‘½åç©ºé—´ç”Ÿæ•ˆ
subjects:
- kind: User
  name: wang      # å¿…é¡»ä¸Ž kubeconfig ä¸­ user.name æˆ–è®¤è¯ç³»ç»Ÿä¸­çš„ç”¨æˆ·åä¸€è‡´
  apiGroup: ""
roleRef:
  kind: ClusterRole        # â† å…³é”®ï¼šå¼•ç”¨çš„æ˜¯ ClusterRole
  name: pods-viewer-cluster
  apiGroup: rbac.authorization.k8s.io
eof
```

> ðŸ”’ å®‰å…¨æç¤ºï¼šè™½ç„¶ ClusterRole æ˜¯å…¨å±€çš„ï¼Œä½†é€šè¿‡ **RoleBinding** ç»‘å®šåŽï¼Œæƒé™**ä»…é™äºŽ `dev` å‘½åç©ºé—´**ï¼Œä¸ä¼šæ³„éœ²åˆ°å…¶ä»– namespaceã€‚

------

#### 3. åº”ç”¨é…ç½®

```bash
kubectl  create ns dev
kubectl apply -f clusterrole-pods-viewer.yaml
kubectl apply -f rolebinding-wang-dev.yaml
```

------

### ðŸ†š å¯¹æ¯”è¯´æ˜Ž

| é¡¹ç›®         | Role + RoleBinding         | ClusterRole + RoleBindingï¼ˆæŽ¨èï¼‰ |
| ------------ | -------------------------- | --------------------------------- |
| æƒé™å®šä¹‰ä½ç½® | æ¯ä¸ª namespace å•ç‹¬å®šä¹‰    | å…¨å±€å®šä¹‰ä¸€æ¬¡                      |
| å¤ç”¨æ€§       | å·®ï¼ˆdev/staging éœ€é‡å¤å†™ï¼‰ | é«˜ï¼ˆæ‰€æœ‰ ns å¯å…±ç”¨ï¼‰              |
| ç®¡ç†æˆæœ¬     | é«˜                         | ä½Ž                                |
| é€‚ç”¨åœºæ™¯     | å•ä¸€ã€éš”ç¦»çŽ¯å¢ƒ             | å¤šçŽ¯å¢ƒã€ç”Ÿäº§é›†ç¾¤                  |

------

### ðŸ” å¦‚æžœéœ€è¦è·¨å¤šä¸ªå‘½åç©ºé—´ï¼Ÿ

åªéœ€ä¸ºæ¯ä¸ªå‘½åç©ºé—´åˆ›å»ºä¸€ä¸ª RoleBindingï¼ŒæŒ‡å‘åŒä¸€ä¸ª ClusterRoleï¼š

```bash
# ä¾‹å¦‚å†ç»™ staging å‘½åç©ºé—´æŽˆæƒ
kubectl create rolebinding wang-pods-reader-in-staging \
  --clusterrole=pods-viewer-cluster \
  --user=wang \
  --namespace=staging
```

------

### ðŸ’¡ è¡¥å……ï¼šå¦‚ä½•éªŒè¯æƒé™ï¼Ÿ

```bash
# ä½¿ç”¨ä½ çš„ kubeconfig æµ‹è¯•
kubectl auth can-i list pods --namespace=dev 
kubectl auth can-i get deployments --namespace=dev
kubectl auth can-i list nodes   # åº”è¯¥è¿”å›ž no
```



---



```powershell
kubectl get sa  -A


```

```powershell
cat > pod-with-sa.yaml <<'eof'
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  namespace: dev
spec:
  serviceAccountName: my-sa
  containers:
  - name: app
    image: nginx
eof
```

```powershell
kubectl create serviceaccount my-sa -n dev	&& kubectl  get sa -n dev

kubectl apply -f pod-with-sa.yaml

kubectl exec -it my-app -n dev -- ls /var/run/secrets/kubernetes.io/serviceaccount/
kubectl exec -it my-app -n dev -- cat /var/run/secrets/kubernetes.io/serviceaccount/token
```



---

## âœ… ä¸€ã€åˆ›å»º Pod æŸ¥çœ‹æŒ‚è½½çš„ SA æ–‡ä»¶

Kubernetes ä¼š**è‡ªåŠ¨**å°† ServiceAccount çš„ç›¸å…³å‡­è¯æŒ‚è½½åˆ°æ¯ä¸ª Pod çš„å›ºå®šè·¯å¾„ä¸‹ï¼ˆé™¤éžæ˜¾å¼ç¦ç”¨ï¼‰ï¼š

> **æŒ‚è½½è·¯å¾„ï¼š`/var/run/secrets/kubernetes.io/serviceaccount/`**

åˆ›å»º POD YAML æ–‡ä»¶

```powershell
cat > pod-with-sa.yaml <<'eof'
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  namespace: dev
spec:
  serviceAccountName: my-sa
  containers:
  - name: app
    image: nginx
eof
```

### æ­¥éª¤å¦‚ä¸‹ï¼š

#### 1. ç¡®ä¿ SA å­˜åœ¨ï¼ˆå¦‚æžœè¿˜æ²¡åˆ›å»ºï¼‰

```bash
kubectl create serviceaccount my-sa -n dev
```

#### 2. åº”ç”¨ä½ çš„ Pod

```bash
kubectl apply -f pod-with-sa.yaml
```

#### 3. è¿›å…¥ Pod æŸ¥çœ‹æŒ‚è½½å†…å®¹

```bash
kubectl exec -it my-app -n dev -- ls /var/run/secrets/kubernetes.io/serviceaccount/
```

ä½ åº”è¯¥çœ‹åˆ°ä¸‰ä¸ªæ–‡ä»¶ï¼š

```
ca.crt          # é›†ç¾¤ CA è¯ä¹¦ï¼Œç”¨äºŽéªŒè¯ API Server èº«ä»½
namespace       # å½“å‰ Pod æ‰€åœ¨çš„å‘½åç©ºé—´ï¼ˆè¿™é‡Œæ˜¯ "dev"ï¼‰
token           # Bearer Tokenï¼Œç”¨äºŽå‘ API Server è¯æ˜Žèº«ä»½ï¼ˆå³ SA çš„å‡­è¯ï¼‰
```

ä½ å¯ä»¥è¿›ä¸€æ­¥æŸ¥çœ‹å†…å®¹ï¼š

```sh
kubectl exec -it my-app -n dev -- cat /var/run/secrets/kubernetes.io/serviceaccount/token
kubectl exec -it my-app -n dev -- cat /var/run/secrets/kubernetes.io/serviceaccount/namespace
kubectl exec -it my-app -n dev -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
```

> ðŸ” è¿™ä¸ª `token` å°±æ˜¯è¯¥ ServiceAccount å¯¹åº”çš„ Secret ä¸­çš„ `token` å­—æ®µï¼ˆé€šå¸¸æ˜¯ `my-sa-token-xxxxx` ç±»åž‹çš„ secretï¼‰ã€‚

---

##  æ€»ç»“ï¼š

| ç›®æ ‡             | æ“ä½œ                                                |
| ---------------- | --------------------------------------------------- |
| æŸ¥çœ‹ SA æŒ‚è½½æ–‡ä»¶ | `ls /var/run/secrets/kubernetes.io/serviceaccount/` |
| ç†è§£ SA èº«ä»½     | token = SA çš„â€œå¯†ç â€                                 |
| ç†è§£æƒé™æŽ§åˆ¶     | RBAC ç»‘å®šå†³å®šèƒ½åšä»€ä¹ˆ                               |
| å®‰å…¨å®žè·µ         | æŒ‰éœ€æŽˆæƒï¼Œæœ€å°æƒé™ï¼Œå¯ç¦ç”¨æŒ‚è½½                      |





---

## å‡†å…¥æŽ§åˆ¶ï¼ˆAdmission Controlï¼‰

### å¯ç”¨ Pod Security Admission

åœ¨å¯¹è±¡å†™å…¥ etcd å‰è¿›è¡Œæ‹¦æˆªã€‚

```powershell
# ä¸ºå‘½åç©ºé—´ dev å¯ç”¨äº† restricted çº§åˆ«çš„å¼ºåˆ¶ç­–ç•¥ï¼ˆenforceï¼‰å’Œè­¦å‘Šç­–ç•¥ï¼ˆwarnï¼‰
# æµ‹è¯•ç›®æ ‡ï¼šéªŒè¯ Pod Security Admissionï¼ˆPSAï¼‰åœ¨ restricted æ¨¡å¼ä¸‹æ˜¯å¦èƒ½é˜»æ­¢ä¸åˆè§„çš„ Pod åˆ›å»ºã€‚
kubectl label ns dev \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/warn=restricted
```

```powershell
cat > bad-pod.yaml <<'eof'
apiVersion: v1
kind: Pod
metadata:
  name: bad-pod
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx
    securityContext:
      privileged: true   # â† è¿å restricted ç­–ç•¥
eof
```

```powershell
kubectl apply -f bad-pod.yaml
# Error: violates PodSecurity "restricted:latest"
```

```powershell
å›žé€€
# æ³¨æ„ï¼šæ ‡ç­¾åæœ«å°¾çš„ - è¡¨ç¤ºâ€œåˆ é™¤è¯¥æ ‡ç­¾â€ã€‚
kubectl label namespace dev \
  pod-security.kubernetes.io/enforce- \
  pod-security.kubernetes.io/warn-
# éªŒè¯æ˜¯å¦å·²åˆ é™¤ï¼š
kubectl get namespace dev --show-labels
```







## ç½‘ç»œ

flannel å·¥ä½œæ¨¡å¼

- vxlan ï¼ˆudp 8472ï¼‰
- host-gw
- direct-routing ï¼ˆæ··åˆï¼‰

flannel pod é—´é€šä¿¡

- åŒä¸€ä¸ªèŠ‚ç‚¹é€šä¿¡ ï¼ˆ CNI0 ç½‘æ¡¥ ï¼‰
- ä¸åŒä¸€ä¸ªèŠ‚ç‚¹é€šä¿¡

calico

