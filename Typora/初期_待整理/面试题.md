# 面试题

> 关于 Keepalived、Nginx、LVS 和 MySQL 的运维面试题清单。

## 一、Keepalived 面试题

> **基础概念：**
>
> 1.  什么是 Keepalived？它的核心作用是什么？
> 2.  Keepalived 是基于什么协议实现高可用的？请简述该协议的工作原理。
> 3.  解释一下什么是 VRRP 虚拟路由器、虚拟 IP 和优先级。
> 4.  Keepalived 有哪几种工作模式？它们之间有什么区别？
>
> **核心机制：**
>
> 5.  详细描述一下 Keepalived 的主备切换过程。
> 6.  什么是“脑裂”？在 Keepalived 中如何导致脑裂，又该如何避免和检测？
> 7.  Keepalived 的健康检查机制是如何工作的？如何自定义一个健康检查脚本？
> 8.  如何实现 Keepalived 的双主模式？有什么应用场景？
>
> **配置与排错：**
> 9.  讲一下 `keepalived.conf` 配置文件的主要结构，包括全局定义、VRRP实例和虚拟服务器定义。
> 10.  如何通过命令查看 Keepalived 的日志来排查故障？
> 11.  当 Keepalived 主备切换失败时，你的排查思路是什么？

```powershell
### 一、Keepalived 实战答案
4. 主要是抢占和非抢占这两个模式。
默认是抢占模式，该模式运行逻辑是当master节点故障恢复后，会立刻抢回master身份和vip。
风险是主节点还没有完全恢复过来，就已经抢回了vip，会导致服务短暂异常。适用于主节点的物理机性能明显高于其他节点物理机的情况。


5. 详细描述一下 Keepalived 的主备切换过程。

正常状态：主节点周期性地（默认1秒）向多播地址 224.0.0.18 发送 VRRP 通告，宣告自己存活。主节点持有 VIP。

故障检测：

节点宕机：备份节点在 3 * heartbeat_interval + skew_time 后（约3秒）未收到主节点通告，判定主节点死亡。

服务故障：如果配置了健康检查脚本（如 chk_nginx），当脚本执行失败时，主节点会主动降低自己的优先级（如 priority - 20），并发送一个优先级为0的通告，告知备份节点“我要退位了”。

状态切换：备份节点发现自己的优先级高于收到的通告（或超时），会将自己状态转换为 MASTER。

VIP 转移：新的主节点会做两件关键事：

发送免费ARP：向局域网广播 gratuitous ARP 包，刷新所有设备的ARP缓存，告知VIP对应的MAC地址已变更到此机器。这是最关键的一步，生产环境中ARP缓存问题可能导致切换后短暂不可用。

绑定VIP：将虚拟IP添加到指定的网络接口上。

流量接管：此后，所有发送到VIP的流量被路由到新的主节点。

6. 什么是“脑裂”？如何避免？

现象：两台节点都认为自己是Master，并且都绑定了VIP。导致客户端请求混乱，一部分发往A，一部分发往B，服务异常。

生产环境常见原因：

防火墙阻断：未放行VRRP协议（IP协议号112）或多播地址 224.0.0.18 的通信。

网络抖动/隔离：主备节点之间的网络链路不稳定，导致备份节点误认为主节点宕机而抢占。

系统负载过高：主节点系统负载过高，无法及时处理VRRP通告，导致超时。

解决方案：

强化心跳链路：使用双心跳线，或通过第三方脚本作为仲裁。例如，让主备节点都去ping一个可靠的网关或者一个独立的仲裁服务器。

使用脚本监控：在Keepalived配置中编写脚本，不仅检查本地服务，还检查对方节点的服务状态。如果发现自己能通公网IP但对方节点VIP也存在，则自动降低自身优先级或关闭Keepalived进程。

日志监控与告警：必须监控Keepalived的日志，一旦出现“IP conflict”或“双主”日志，立即告警，因为脑裂本身是紧急故障，需要人工干预。

7. 如何自定义一个健康检查脚本？

以检查Nginx为例：

脚本 (/etc/keepalived/check_nginx.sh)：

bash
#!/bin/bash
# Check if Nginx processes are running
if [ `pgrep -c nginx` -lt 1 ]; then
    # If not, try to restart locally first
    systemctl restart nginx 2>/dev/null 1>/dev/null
    # Wait a moment and check again
    sleep 2
    if [ `pgrep -c nginx` -lt 1 ]; then
        # If still not running, return 1 to indicate failure
        exit 1
    fi
fi
exit 0
配置 (keepalived.conf)：

conf
vrrp_script chk_nginx {
    script "/etc/keepalived/check_nginx.sh"
    interval 2   # 检查间隔
    weight -20   # 检查失败时，优先级降低20
    fall 2       # 连续失败2次才认为失败
    rise 1       # 成功1次就认为恢复
}

track_script {
    chk_nginx
}
生产注意：脚本一定要有超时控制，并且权限是 755。weight -20 的方式比直接 priority 0 更优雅，因为它允许服务恢复后节点能重新成为Master。
```



### 二、Nginx 面试题

> **基础与架构：**
> 1.  Nginx 是什么？它和 Apache 的主要区别是什么？（例如：事件驱动 vs 多进程/多线程）
> 2.  请解释 Nginx 的 `master-worker` 进程模型及其优势。
> 3.  Nginx 作为反向代理和负载均衡器，有什么区别？
>
> **配置与使用：**
> 4.  如何实现 Nginx 的反向代理？请写出一个简单的 `location` 配置块。
> 5.  Nginx 负载均衡的常用调度算法有哪些？（如 `round-robin`, `ip_hash`, `least_conn`, `weight`）
> 6.  什么是“上游服务器”？如何在 Nginx 中配置一个上游服务器组？
> 7.  如何让 Nginx 支持 WebSocket 代理？
> 8.  解释一下 `try_files` 指令的作用。
>
> **性能与优化：**
> 9.  如何优化 Nginx 的性能？（例如：调整 worker_processes, worker_connections, 开启 Gzip 压缩，设置缓存）
> 10. 如何限制客户端的访问速率？
> 11. Nginx 如何实现动静分离？这样做有什么好处？
>
> **排错：**
> 12. 如何平滑重启或重载 Nginx 配置？
> 13. 如何查看 Nginx 的状态信息？（如使用 `stub_status` 模块）

```powershell
二、Nginx 实战答案
5. Nginx 负载均衡的常用调度算法

round-robin：默认，轮询。生产上会给性能好的服务器更高权重，如 weight=3。

ip_hash：基于客户端IP进行哈希，保证同一IP的请求总是落到同一台后端。用于解决Session保持问题，但后端服务器宕机会导致大量Session丢失。

least_conn：将请求发送给当前连接数最少的后端。在连接生命周期长短不一的场景（如FTP、数据库连接池）下效果更好。

hash $key：一致性哈希，可以自定义key（如$request_uri）。用于缓存负载，能最大限度地提高缓存的命中率。

6. 配置上游服务器组

nginx
upstream backend_servers {
    # 使用最少连接算法
    least_conn;
    
    # 定义后端服务器，down表示暂时下线，backup表示备份服务器
    server 192.168.1.11:8080 weight=3 max_fails=2 fail_timeout=30s;
    server 192.168.1.12:8080 weight=1 max_fails=2 fail_timeout=30s;
    server 192.168.1.13:8080 backup; # 只有当主服务器全挂时，它才启用
}

server {
    listen 80;
    location / {
        proxy_pass http://backend_servers;
        # 以下是生产级代理参数
        proxy_connect_timeout 5s;    # 与后端服务器建立连接的超时时间
        proxy_read_timeout 60s;      # 等待后端响应的时间
        proxy_send_timeout 30s;      # 向后端发送请求的超时时间
        proxy_next_upstream error timeout http_500 http_502 http_504; # 在什么情况下请求下一台服务器
    }
}
生产关键：max_fails 和 fail_timeout 是核心，它们定义了Nginx的健康检查机制。如果一台服务器在 fail_timeout 时间内连续失败 max_fails 次，它会被标记为不可用，并在 fail_timeout 后才再次尝试。


```



### 三、LVS 面试题

> **基础与原理：**
> 1.  什么是 LVS？它在 OSI 模型的哪一层工作？
> 2.  LVS 有哪三种主要工作模式？请详细说明它们的原理、流程和优缺点。
>     *   NAT
>     *   DR
>     *   TUN
> 3.  为什么 LVS-DR 模式性能最高？
>
> **组件与操作：**
> 4.  LVS 主要由哪几个核心组件组成？（IPVS, ipvsadm）
> 5.  如何使用 `ipvsadm` 命令来添加一个 LVS 虚拟服务和一个真实服务器？
> 6.  在 LVS-DR 模式下，为什么要在真实服务器上配置 ARP 抑制？如何配置？
>
> **集群与高可用：**
> 7.  LVS 本身如何避免单点故障？通常和什么软件配合使用？
> 8.  描述一个典型的 LVS + Keepalived 架构的工作流程。

```powershell
三、LVS 实战答案
2. LVS 三种工作模式的对比

模式	原理	优点	缺点	生产应用场景
NAT	调度器修改请求/响应包的IP地址。	配置简单，真实服务器可使用任何OS。	调度器成为性能瓶颈，所有流量都经过它。	现在已较少使用，主要用于内部系统或实验环境。
DR	调度器只修改请求包的MAC地址，直接路由给RS，RS直接响应客户端。	性能极高，调度器压力小。	要求RS和调度器在同一物理网络，且需要在RS上配置ARP抑制。	****互联网公司最常用的模式，用于Web、API等无状态服务的负载均衡。
TUN	通过IP隧道进行通信，调度器和RS可以跨机房。	可以突破地理限制。	需要RS支持隧道协议，配置复杂，有封装解封装开销。	用于异地容灾或特定需要跨网络段的场景。
6. LVS-DR 模式下如何配置 ARP 抑制？

为什么？ 防止真实服务器直接响应客户端发来的ARP请求，导致VIP被多个机器持有，扰乱负载均衡。

如何配置（在真实服务器上）：

bash
# 1. 创建ARP抑制的配置文件
echo 'net.ipv4.conf.all.arp_ignore = 1' >> /etc/sysctl.conf
echo 'net.ipv4.conf.all.arp_announce = 2' >> /etc/sysctl.conf
echo 'net.ipv4.conf.lo.arp_ignore = 1' >> /etc/sysctl.conf
echo 'net.ipv4.conf.lo.arp_announce = 2' >> /etc/sysctl.conf

# 2. 使配置生效
sysctl -p

# 3. 在lo回环接口上配置VIP（注意掩码是32位）
ip addr add 192.168.1.100/32 dev lo
# 为了让配置永久生效，可以将此命令写入 /etc/rc.local
生产坑点：重启服务器后 lo 接口的VIP会丢失，务必将其添加到启动脚本中。
```



### 四、MySQL 面试题

> **基础与架构：**
> 1.  MySQL 的存储引擎 InnoDB 和 MyISAM 有什么区别？（事务、锁、外键等）
> 2.  什么是事务？MySQL 如何保证事务的 ACID 特性？
> 3.  解释一下 MySQL 的二进制日志和中继日志分别有什么作用。
>
> **复制与高可用：**
> 4.  请详细描述 MySQL 主从复制的原理。
> 5.  如何监控主从复制是否延迟？如果延迟了，如何排查？
> 6.  除了主从复制，你还了解哪些 MySQL 高可用方案？（如 MHA, MGR, PXC, Orchestrator+Keepalived）
>
> **性能优化：**
> 7.  如何定位并优化一条慢 SQL 查询？（考察 `EXPLAIN` 命令的使用）
> 8.  什么是索引？在哪些情况下索引会失效？
> 9.  你如何进行 MySQL 的备份和恢复？（逻辑备份 vs 物理备份）
>
> **运维实战：**
> 10. 当数据库服务器 CPU 使用率突然飙升到 100%，你的排查思路是什么？
> 11. 如何对一个大表进行 DDL 操作（如加字段）而尽量减少对业务的影响？（使用 `pt-online-schema-change`）

```powershell
四、MySQL 实战答案
7. 如何定位并优化一条慢 SQL 查询？

开启慢查询日志：在 my.cnf 中设置 slow_query_log=1, long_query_time=2（秒）。

使用 EXPLAIN：这是最核心的工具。

sql
EXPLAIN SELECT * FROM users WHERE name = 'foo' AND age > 20;
重点看这几列：

type：访问类型。从好到坏：system > const > eq_ref > ref > range > index > ALL。生产环境中至少要优化到 range 级别，杜绝 ALL（全表扫描）。

key：实际使用的索引。如果为NULL，说明没用到索引。

rows：预估需要扫描的行数。值越大越差。

Extra：额外信息。出现 Using filesort（需要额外排序）或 Using temporary（使用临时表）通常意味着需要优化。

优化手段：

加索引：在 WHERE、ORDER BY、GROUP BY 的列上创建索引。联合索引要注意最左前缀原则。

改写SQL：避免使用 SELECT *，避免在索引列上使用函数或运算（如 WHERE YEAR(create_time) = 2023），改用范围查询。

10. 数据库服务器 CPU 使用率 100% 排查思路

这是一个经典的线上故障排查流程：

紧急止损：确认是否有异常SQL或大量请求，考虑** Kill 掉问题会话或从负载均衡器暂时摘掉该数据库**。

定位问题进程：

登录数据库，执行 SHOW PROCESSLIST; 查看当前所有连接，找出状态是 executing 且时间很长的SQL。

使用 SELECT * FROM information_schema.PROCESSLIST WHERE COMMAND != 'Sleep' ORDER BY TIME DESC; 更精细地查看。

分析慢查询：检查慢查询日志，看是否有新的慢SQL出现。

检查系统状态：使用 top 命令，按 1 看每个CPU核心的负载。如果 %us（用户态）很高，通常是SQL问题；如果 %sy（内核态）高，可能是系统调用频繁或上下文切换过多。

检查锁竞争：如果CPU不高但业务感觉卡顿，可能是锁等待。查询 SHOW ENGINE INNODB STATUS\G 查看 TRANSACTIONS 部分的锁信息。

根治：根据第2、3步找到的罪魁祸首SQL，使用 EXPLAIN 进行分析和优化（如加索引）。
```



##### 五、综合场景题（考察实战能力）

> 1.  **场景一**：请设计一个高可用的 Web 架构，要求能承载高并发流量，并保证负载均衡器和数据库都没有单点故障。请画出架构图并说明各组件的选型和原因。
>     *   **期望答案**：前端 LVS + Keepalived 做四层负载，中间 Nginx + Keepalived 做七层负载和动静分离，后端 Web 集群，数据库采用主从复制+MHA/Orchestrator+VIP 实现高可用。
>
> 2.  **场景二**：用户报告网站访问时好时坏。你登录服务器后发现，Nginx 的 error log 中有大量的 `Connection timed out` 错误，指向上游的 Tomcat 服务器。你的排查步骤是什么？
>     *   **考察点**：系统性的排错思路，包括网络、防火墙、Tomcat 本身状态、负载均衡配置等。
>
> 3.  **场景三**：在 MySQL 主从环境中，主库上误执行了一个 `DROP DATABASE` 操作，你如何利用已有的备份和二进制日志进行数据恢复？
>     *   **考察点**：备份恢复流程、Binlog 的应用。
>
> 4.  **场景四**：如何实现一个“蓝绿部署”或“金丝雀发布”的流程？在这个流程中，Nginx 和 Keepalived 可以扮演什么角色？
>     *   **考察点**：对现代部署流程的理解和工具的应用能力。

```powershell
五、综合场景题答案
1. 高可用 Web 架构设计

text
[ 互联网 ]
    |
[ F5 / 硬件SLB ] (可选，用于多机房流量调度)
    |
[ LVS + Keepalived 集群 ] (Active-Standby, VIP: 192.168.1.100)
    | (四层负载，DR模式，高性能分流)
[Nginx + Keepalived 集群 ] (Active-Standby, VIP: 192.168.1.200)
    | (七层负载，处理SSL、动静分离、路由)
[ Tomcat Cluster ] (Web Server 1, 2, 3...)
    |
[ Redis Cluster ] (Session共享或缓存)
    |
[ MySQL Cluster ] (Master-Slave with MHA, VIP: 192.168.1.50)
    |
[ 分布式文件存储 / Ceph ]
选型理由：

LVS：性能极致，处理底层TCP连接，无惧SYN Flood等攻击。

Nginx：功能强大，处理应用层逻辑（域名转发、限流、WAF等）。

Keepalived：为LVS和Nginx本身提供高可用，解决单点问题。

MHA：专门为MySQL主从切换设计，比单纯用Keepalived更可靠，能解决数据一致性和Binlog位置点问题。

这套架构兼顾了性能、高可用和扩展性，是经过无数互联网公司验证的经典方案。
```

