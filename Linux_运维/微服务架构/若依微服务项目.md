### è‹¥ä¾å¾®æœåŠ¡é¡¹ç›®

- 10.0.0.100	www.duan.org	nginx åå‘ä»£ç†å’Œæ‰€æœ‰è‹¥ä¾é¡¹ç›®å‰åç«¯åº”ç”¨çš„å¾®æœåŠ¡ï¼›
- 10.0.0.101	nacos.duan.org mysql.duan.org redis.duan.org	åŸºç¡€æœåŠ¡ï¼šnacosã€MySQLã€Redis

```powershell
# æ‰€æœ‰ä¸»æœºèŠ‚ç‚¹é€šè¿‡/etc/hostså®ç°å®ç°åŸŸåè§£æ
echo '10.0.0.101 nacos.duan.org mysql.duan.org redis.duan.org' >> /etc/hosts
```

##### åŸºç¡€ç¯å¢ƒå‡†å¤‡

ä¸‹è½½é¡¹ç›®æºä»£ç å¹¶ä¿®æ”¹Nacoså’Œæ•°æ®åº“è¿æ¥é…ç½® (10.0.0.100)

```powershell
apt update && apt -y install git maven npm docker.io docker-compose python3-pip
# ä¸‹è½½è‹¥ä¾å¾®æœåŠ¡é¡¹ç›®æºç æ–‡ä»¶
git clone https://gitee.com/y_project/RuoYi-Cloud.git
# æŸ¥çœ‹NacosæœåŠ¡åœ°å€
cd /root/RuoYi-Cloud && grep -r ruoyi-nacos:8848 *
# ä¿®æ”¹RuoYIåº”ç”¨çš„Nacosåœ°å€ä¸ºnacos.duan.org
cd /root/RuoYi-Cloud && grep -r ruoyi-nacos:8848 * |awk -F: '{print $1}'|uniq |xargs sed -i 's#ruoyi-nacos:8848#nacos.duan.org:8848#'
# ç¡®è®¤åœ°å€ä¿®æ”¹å®Œæˆ
cd /root/RuoYi-Cloud && grep -r nacos.duan.org:8848 *

# æŸ¥çœ‹æ•°æ®åº“è„šæœ¬,å…¶ä¸­ry_config_20231204.sqlæ˜¯Nacosçš„é…ç½®ä¸­å¿ƒä¿å­˜çš„RuoYiçš„é…ç½®ä¿¡æ¯
ls /root/RuoYi-Cloud/sql
quartz.sql ry_20231130.sql ry_config_20231204.sql ry_seata_20210128.sql
# æŸ¥çœ‹Nacosé…ç½®ä¸­å¿ƒçš„Ruoyiçš„æ•°æ®åº“è¿æ¥ä¿¡æ¯
cd /root/RuoYi-Cloud && grep -E "mysql|redis" sql/ry_config_20231204.sql
# ä¿®æ”¹MySQLå’ŒRedisè¿æ¥é…ç½®ä¿¡æ¯
cd /root/RuoYi-Cloud && sed -i -e 's#ruoyi-mysql:3306#mysql.duan.org#g' -e 's#ruoyi-redis#redis.duan.org#g' sql/ry_config_20231204.sql
```

å®‰è£…å’Œé…ç½® Redis (10.0.0.101)

```powershell
apt update && apt -y install redis
# ä¿®æ”¹redisé…ç½®
sed -i.bak -e 's/^bind .*/bind 0.0.0.0/' -e 's/^protected-mode.*/protected-mode no/' /etc/redis/redis.conf

systemctl restart redis
# æµ‹è¯•è¿æ¥
redis-cli info Server
```

å®‰è£…å’Œé…ç½® MySQL (10.0.0.101)

```powershell
# å®‰è£…å’Œé…ç½®MySQL
apt update && apt -y install mysql-server
sed -i '/127.0.0.1/s/^/#/' /etc/mysql/mysql.conf.d/mysqld.cnf

systemctl restart mysql
# å‡†å¤‡æ•°æ®åº“è¡¨å’Œæ•°æ®åŠç”¨æˆ·
mysql
# æ ¹æ®ry_config_20231204.sqlä¸­çš„ä¿¡æ¯å‡†å¤‡RuoYiåº”ç”¨æ‰€éœ€çš„æ•°æ®åº“é…ç½®
create database ry-cloud;
create user root@'%' identified by '123123';
grant all on ry-cloud.* to root@'%';
grant all on ry-seata.* to root@'%';
# å¯¼å…¥RuoYiåº”ç”¨æ‰€éœ€çš„æ•°æ®è¡¨
use ry-cloud
source /root/RuoYi-Cloud/sql/quartz.sql
source /root/RuoYi-Cloud/sql/ry_20231130.sql
# åˆ›å»ºSeataæœåŠ¡éœ€è¦çš„æ•°æ®åº“å’Œè¡¨(å¯é€‰)
source /root/RuoYi-Cloud/sql/ry_seata_20210128.sql
# NacosæœåŠ¡æ‰€éœ€çš„æ•°æ®åº“é…ç½®
source /root/RuoYi-Cloud/sql/ry_config_20231204.sql
# éœ€è¦æŒ‡å®šéªŒè¯æ’ä»¶ï¼Œä¸æ”¯æŒé»˜è®¤æ’ä»¶caching_sha2_password
create user nacos@'%' identified with mysql_native_password by '123123';
grant all on ry-config.* to nacos@'%';
# æŸ¥çœ‹ç”Ÿæˆä¸‰ä¸ªæ•°æ®åº“
show databases;
# æŸ¥çœ‹åˆ›å»ºçš„ç”¨æˆ·
select user,host from mysql.user;

# æµ‹è¯•ç”¨æˆ·è®¿é—®Nacosçš„è¡¨
mysql -unacos -p123123 -hmysql.duan.org -e 'show tables in ry-config'
# æµ‹è¯•ç”¨æˆ·è®¿é—®RuoYiçš„è¡¨
mysql -uroot -p123123 -hmysql.duan.org -e 'show tables in ry-cloud'
mysql -uroot -p123123 -hmysql.duan.org -e 'show tables in ry-seata'
```

å®‰è£…å’Œé…ç½® Nacos (10.0.0.101)

- æ³¨æ„:éœ€è¦å®‰è£…Nacos-2.4.3ä»¥å‰ç‰ˆæœ¬,Nacos-2.5.Xä»¥åç‰ˆæœ¬ä¸æ”¯æŒ

```powershell
# å®‰è£…Nacos
apt update && apt -y install openjdk-8-jdk
wget https://download.nacos.io/nacos-server/nacos-server-2.5.2.zip?spm=5238cd80.47ee59c.0.0.189fcd36iQTqYu&file=nacos-server-2.5.2.zip
unzip nacos-server-2.5.2.zip -d /usr/local/
#  å‡†å¤‡Seviceæ–‡ä»¶
id nacos &> /dev/null || useradd -r -s /sbin/nologin nacos
chown -R nacos: /usr/local/nacos/ && ll /usr/local/nacos/
cat > /lib/systemd/system/nacos.service <<eof
[Unit]
Description=nacos.service
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/nacos/bin/startup.sh -m standalone
ExecStop=/usr/local/nacos/bin/shutdown.sh
User=nacos
Group=nacos
[Install]
WantedBy=multi-user.target
eof

systemctl daemon-reload
# ä¿®æ”¹Nacosä½¿ç”¨MySQLæ•°æ®åº“
vim /usr/local/nacos/conf/application.properties
spring.sql.init.platform=mysql
db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/ry-config?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user.0=nacos
db.password.0=123123

systemctl restart nacos.service && systemctl status nacos.service
# æŸ¥çœ‹æ—¥å¿—
tail /usr/local/nacos/logs/startup.log
# æµè§ˆå™¨è®¿é—®ï¼š10.0.0.101:8848/nacos
```

ç™»å½• Nacos æŸ¥çœ‹åˆ°é…ç½®ä¸­å¿ƒçš„é…ç½®å¦‚ä¸‹ï¼š

![image-20251202162334374](C:/Program Files/Obsidian/data/Obsidian_Vault/image-20251202162334374.png)

##### å®éªŒæ•…éšœæ€»ç»“ï¼š

```python
ğŸ”§ é—®é¢˜æ ¹æº
Nacos 2.5.2 éœ€è¦ config_info_gray è¡¨ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰åˆ›å»ºè¯¥è¡¨
ğŸ“‹ æ’æŸ¥è¿‡ç¨‹
é”™è¯¯ç°è±¡ï¼šNacos å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—æŠ¥é”™ Table 'ry-config.config_info_gray' doesn't exist

éªŒè¯ç¡®è®¤ï¼š
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -hnacos.duan.org -unacos -p123123 -e "USE \ry-config\; SELECT 1;"

ğŸ’¡ è§£å†³æ–¹æ¡ˆ
åœ¨ ry-config æ•°æ®åº“ä¸­åˆ›å»ºç¼ºå¤±çš„è¡¨ï¼š
mysql -uroot -p << 'EOF'
USE ry-config;

CREATE TABLE IF NOT EXISTS config_info_gray (
  id bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  data_id varchar(255) NOT NULL COMMENT 'data_id',
  group_id varchar(128) DEFAULT NULL,
  tenant_id varchar(128) DEFAULT '' COMMENT 'ç§Ÿæˆ·å­—æ®µ',
  content longtext NOT NULL COMMENT 'content',
  md5 varchar(32) DEFAULT NULL COMMENT 'md5',
  src_ip varchar(50) DEFAULT NULL COMMENT 'source ip',
  src_user varchar(128) DEFAULT NULL COMMENT 'source user',
  app_name varchar(128) DEFAULT NULL,
  type varchar(32) DEFAULT NULL,
  encrypted_data_key text NOT NULL COMMENT 'å¯†é’¥',
  gmt_create datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  gmt_modified datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
  PRIMARY KEY (id),
  UNIQUE KEY uk_configinfogray_datagrouptenant (data_id,group_id,tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='config_info_gray';

SHOW TABLES LIKE 'config_info_gray';
EOF

âœ… ä¿®å¤ç»“æœ
åˆ›å»º config_info_gray è¡¨æˆåŠŸ
é‡æ–°å¯åŠ¨ MySQLã€Nacos
æœåŠ¡æ¢å¤å¯ç”¨
```

##### æ„å»ºåç«¯JAVAå¾®æœåŠ¡

```python
# mavenåŠ é€Ÿé…ç½®(å¯é€‰,å› ä¸ºRuoYiæœ¬èº«é¡¹ç›®å·²æœ‰é…ç½®åŠ é€Ÿ,æ­¤æ­¥å¯ä¸åš)
vim /etc/maven/settings.xml
.....
    <mirror>
      <id>nexus-aliyun</id>
      <mirrorOf>*</mirrorOf>
      <name>Nexus aliyun</name>
      <url>http://maven.aliyun.com/nexus/content/groups/public</url>
    </mirror>

# æ„å»ºåç«¯å¾®æœåŠ¡é¡¹ç›®
cd /root/RuoYi-Cloud && mvn clean package -Dmaven.test.skip=true
# éªŒè¯ç¼–è¯‘ç»“æœ 
cd /root/RuoYi-Cloud && find ruoyi-*/ -name "*.jar"
# å®Œæˆå¤åˆ¶ç›¸å…³çš„jaræ–‡ä»¶åˆ°ç›®å½•/srvä¸­
cd /root/RuoYi-Cloud/docker && bash copy-jar.sh  && ls /srv

# æŒ‰é¡ºåºå¯åŠ¨
nohup java -jar /srv/ruoyi-gateway.jar &>/dev/null &
nohup java -jar /srv/ruoyi-auth.jar &>/dev/null &
nohup java -jar /srv/ruoyi-modules-system.jar &>/dev/null &
nohup java -jar /srv/ruoyi-modules-gen.jar &>/dev/null &
nohup java -jar /srv/ruoyi-modules-job.jar &>/dev/null &
nohup java -jar /srv/ruoyi-modules-file.jar &>/dev/null&
nohup java -jar /srv/ruoyi-visual-monitor.jar &>/dev/null &

ss -ntlp|grep java
# æ¯å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼Œåœ¨ Nacos webç•Œé¢çš„æœåŠ¡ç®¡ç†çš„æœåŠ¡åˆ—è¡¨å°±æœ‰ä¸€ä¸ªæ³¨å†Œä¿¡æ¯ç”Ÿæˆï¼›
# è™½ç„¶å¼€å¾ˆå¤šæœåŠ¡ï¼Œä½†æ˜¯æœ€éœ€è¦è®¿é—®APIç½‘å…³ï¼Œå¯ä»¥åœ¨ Nacos webç•Œé¢æŸ¥çœ‹  ruoyi-gateway æœåŠ¡ä¿¡æ¯ï¼›
# ä¹Ÿå¯ä»¥åœ¨ç»ˆç«¯é€šè¿‡ ps aux|grep java å’Œ ss -ntlp|grep java å¯¹ç…§æŸ¥çœ‹å¾—åˆ°APIç½‘å…³ä¿¡æ¯ï¼›
```

##### å®éªŒæ•…éšœæ€»ç»“ï¼š

```powershell
# åœ¨è¿è¡Œåˆ° java -jar /srv/ruoyi-modules-system.jar æœåŠ¡æ—¶é‡åˆ°è®¤è¯å¤±è´¥çš„æ•…éšœ
# æ‰€ä»¥æˆ‘è¦å°†å¯†ç å›é€€åˆ°ç‹è€å¸ˆç»™å®šçš„å¯†ç ï¼›-- ä¿®æ”¹ root@'%' ç”¨æˆ·çš„å¯†ç ä¸º 'password'
ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'password';
FLUSH PRIVILEGES;
æˆ‘çš„çŒœæƒ³æœç„¶æ²¡é”™ï¼Œè¿™ä¸ªrootç”¨æˆ·çš„å¯†ç ä¸èƒ½æ”¹ï¼å¦åˆ™å¯åŠ¨æœåŠ¡æ—¶å°±è®¤è¯å¤±è´¥ï¼
å¦‚æœä¸æƒ³æ”¹ MySQLè®¾å®šå¥½çš„å¯†ç ï¼Œå¯ä»¥åœ¨webç½‘é¡µè¿™ä¸ªæ¨¡å—ä¸­è¿›è¡Œç¼–è¾‘ï¼Œä¿®æ”¹æœåŠ¡å¯¹åº”jaråŒ…ä¸­çš„è®¤è¯å¯†ç ï¼
ä¹Ÿå¯ä»¥å¯¹MySQLä¸­çš„æ•°æ®åº“æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼šgrep "password: password" /root/RuoYi-Cloud/sql/ry_config_20231204.sql
é€šè¿‡è¿‡æ»¤å‘ç°ä¸‰å¤„ç¬¦åˆï¼Œé‚£ä¹ˆè¿™ä¸‰å¤„ password éƒ½è¦ä¿®æ”¹ï¼
sed -i "s#password: password#password: 123123#" /root/RuoYi-Cloud/sql/ry_config_20231204.sql
ç„¶åé‡æ–°å¯¼å…¥æ•°æ®åº“ï¼š
mysql
use ry-cloud
source /root/RuoYi-Cloud/sql/ry_config_20231204.sql
FLUSH PRIVILEGES;
```

![image-20251202170158343](C:/Program Files/Obsidian/data/Obsidian_Vault/image-20251202170158343.png)

##### æ„å»ºå‰ç«¯åº”ç”¨

```powershell
# ä¸‹è½½è‹¥ä¾å¾®æœåŠ¡é¡¹ç›®æºç æ–‡ä»¶
git clone https://gitee.com/y_project/RuoYi-Cloud.git
apt update && apt -y install npm
npm -v
node -v
# è¿›å…¥å‰ç«¯é¡¹ç›®ä¸‹
cd /root/RuoYi-Cloud/ruoyi-ui
# å®‰è£…ä¾èµ–åŒ…,ubuntu2404é»˜è®¤ä¸æ”¯æŒå½“å‰ç‰ˆæœ¬
npm install --registry=https://registry.npmmirror.com
# ä¸ºè§£å†³ Node.js 17+ ç‰ˆæœ¬ä¸ OpenSSL 3.0 çš„å…¼å®¹æ€§é—®é¢˜ï¼Œè®¾ç½®å˜é‡
export NODE_OPTIONS=--openssl-legacy-provider
# æ„å»ºå‰ç«¯é¡¹ç›®
npm run build:prod
# æ„å»ºå­˜æ”¾åœ¨distç›®å½•
du -sh /root/RuoYi-Cloud/ruoyi-ui/dist/ && ls /root/RuoYi-Cloud/ruoyi-ui/dist
```

##### åå‘ä»£ç†é…ç½®

```powershell
apt update && apt -y install nginx
mkdir -p /data/ruoyi && cp -r /root/RuoYi-Cloud/ruoyi-ui/dist/*  /data/ruoyi && ls /data/ruoyi
# æŸ¥çœ‹é…ç½®æ–‡ä»¶è·¯å¾„
nginx -T|grep include
# å®ç°Nginxåå‘ä»£ç†é…ç½®æ–‡ä»¶
vim /etc/nginx/conf.d/www.duan.org.conf
server {
    listen 80;
    server_name www.duan.org;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /data/ruoyi/;
        try_files $uri $uri/ /index.html;
        index index.html index.htm;
    }
    
    # åç«¯APIä»£ç†
    location /prod-api/ {
        proxy_pass http://10.0.0.101:8080/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

nginx -s reload
```

##### æµ‹è¯•è®¿é—® RuoYI 

```powershell
www.duan.org
# é…ç½®åŸŸåè§£æ(Windowsç³»ç»Ÿä¹Ÿè¦åšå“¦ï¼)
echo "10.0.0.100 www.duan.org" >> /etc/hosts
# ä½¿ç”¨é»˜è®¤ç”¨æˆ·åå¯†ç :admin/admin123 ç™»å½•RuoYiåº”ç”¨ï¼›
ç™»å½•æˆåŠŸï¼Œè‡³æ­¤è‹¥ä¾å¾®æœåŠ¡æ¶æ„ç»“æŸï¼
# ä½†æ˜¯é‚£ä¹ˆå¤šæœåŠ¡ï¼Œé€šå¸¸æ˜¯éœ€è¦ docker å®¹å™¨åŒ–æ–¹ä¾¿ç®¡ç†ï¼›
```



å››ç§è½¯ä»¶å‘å¸ƒæ¨¡å‹ï¼š

- è“ç»¿éƒ¨ç½²ï¼›
- é‡‘ä¸é›€éƒ¨ç½²ï¼›
- æœå†»éƒ¨ç½²ï¼›
- A/B æµ‹è¯•ï¼›



