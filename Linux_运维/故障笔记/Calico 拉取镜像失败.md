
---

# ğŸ§¾ æ•…éšœå¤ç›˜æ€»ç»“ï¼š`node3` ä¸Š Calico Pod å› é•œåƒæ‹‰å–å¤±è´¥æ— æ³•å¯åŠ¨

## ä¸€ã€æ•…éšœç°è±¡

- **æ—¶é—´**ï¼š2025å¹´12æœˆ30æ—¥  
- **å½±å“èŠ‚ç‚¹**ï¼š`node3`ï¼ˆä»…æ­¤èŠ‚ç‚¹ï¼‰  
- **å—å½±å“ç»„ä»¶**ï¼š`calico-node-c9sgd`ï¼ˆ`kube-system` å‘½åç©ºé—´ï¼‰  
- **Pod çŠ¶æ€**ï¼š`ImagePullBackOff`  
- **é”™è¯¯æ—¥å¿—å…³é”®ä¿¡æ¯**ï¼š
  ```
  Failed to pull image "quay.io/calico/cni:v3.31.3": 
  proxyconnect tcp: dial tcp 10.0.0.1:7897: connect: connection refused
  ```

> å…¶ä»–èŠ‚ç‚¹ï¼ˆå¦‚ `node1`ã€`node2`ï¼‰è¿è¡Œå®Œå…¨æ­£å¸¸ï¼Œç›¸åŒé•œåƒå¯æˆåŠŸæ‹‰å–ã€‚

---

## äºŒã€æ ¹å› åˆ†æï¼ˆRoot Causeï¼‰

âœ… **æ ¹æœ¬åŸå› **ï¼š  
`node3` èŠ‚ç‚¹ä¸Šçš„ `containerd` æœåŠ¡è¢« **é€šè¿‡ systemd é…ç½®äº†æ— æ•ˆçš„ HTTP/HTTPS ä»£ç†**ï¼ŒæŒ‡å‘ `http://10.0.0.1:7897`ï¼Œè€Œè¯¥ä»£ç†æœåŠ¡ **æœªè¿è¡Œæˆ–å·²å…³é—­**ï¼Œå¯¼è‡´æ‰€æœ‰é€šè¿‡ containerd æ‹‰å–å¤–ç½‘é•œåƒçš„æ“ä½œå¤±è´¥ã€‚

ğŸ”§ **é…ç½®ä½ç½®**ï¼š
```bash
/etc/systemd/system/containerd.service.d/http-proxy.conf
```

å†…å®¹ç¤ºä¾‹ï¼š
```ini
[Service]
Environment="HTTP_PROXY=http://10.0.0.1:7897"
Environment="HTTPS_PROXY=http://10.0.0.1:7897"
Environment="NO_PROXY=localhost,127.0.0.1,..."
```

> âš ï¸ æ­¤é…ç½® **ä»…ä½œç”¨äº containerd è¿›ç¨‹**ï¼Œä¸å½±å“ shell ç¯å¢ƒå˜é‡æˆ– `curl` ç­‰å‘½ä»¤ï¼Œå› æ­¤é€ æˆâ€œ`curl` èƒ½é€šä½† `crictl pull` å¤±è´¥â€çš„è¿·æƒ‘ç°è±¡ã€‚

---

## ä¸‰ã€æ’æŸ¥è¿‡ç¨‹ï¼ˆå…³é”®æ­¥éª¤ï¼‰

| æ­¥éª¤ | æ“ä½œ | å‘ç° |
|------|------|------|
| 1 | å¯¹æ¯” `node2`ï¼ˆæ­£å¸¸ï¼‰ä¸ `node3`ï¼ˆå¼‚å¸¸ï¼‰çš„ç¯å¢ƒå˜é‡ | `env \| grep -i proxy` å‡ä¸ºç©º â†’ æ’é™¤ shell å±‚ä»£ç† |
| 2 | æ£€æŸ¥ containerd é…ç½®æ–‡ä»¶ | ä¸¤è€… `/etc/containerd/config.toml` æ—  proxy ç›¸å…³é…ç½® |
| 3 | æ‰‹åŠ¨æµ‹è¯•ç½‘ç»œè¿é€šæ€§ | `curl https://quay.io/v2/` åœ¨ä¸¤èŠ‚ç‚¹å‡æˆåŠŸ â†’ ç½‘ç»œ/DNS/TLS æ­£å¸¸ |
| 4 | æ‰‹åŠ¨æ‹‰å–é•œåƒ | `crictl pull` åœ¨ `node2` æˆåŠŸï¼Œåœ¨ `node3` æŠ¥ä»£ç†è¿æ¥æ‹’ç» |
| 5 | æ£€æŸ¥ containerd çš„ systemd ç¯å¢ƒ | `systemctl show --property=Environment containerd` â†’ **å‘ç° node3 æœ‰ä»£ç†è®¾ç½®** |
| 6 | å®šä½é…ç½®æ–‡ä»¶ | å‘ç° `/etc/systemd/system/containerd.service.d/http-proxy.conf` |

ğŸ” **æ’æŸ¥æ–¹æ³•äº®ç‚¹**ï¼š  
é‡‡ç”¨ **æ¨ªå‘å¯¹æ¯”æ³•**ï¼ˆæ­£å¸¸ vs å¼‚å¸¸èŠ‚ç‚¹ï¼‰ï¼Œå¿«é€Ÿç¼©å°èŒƒå›´è‡³èŠ‚ç‚¹æœ¬åœ°é…ç½®å·®å¼‚ã€‚

---

## å››ã€è§£å†³æ–¹æ¡ˆ

### âœ… æ“ä½œæ­¥éª¤
```bash
# 1. åˆ é™¤æ— æ•ˆä»£ç†é…ç½®
sudo rm /etc/systemd/system/containerd.service.d/http-proxy.conf

# 2. é‡è½½ systemd å¹¶é‡å¯ containerd
sudo systemctl daemon-reload
sudo systemctl restart containerd

# 3. éªŒè¯ç¯å¢ƒå˜é‡å·²æ¸…é™¤
systemctl show --property=Environment containerd  # åº”è¿”å›ç©º

# 4. éªŒè¯é•œåƒæ‹‰å–
crictl pull quay.io/calico/cni:v3.31.3  # åº”æˆåŠŸ

# 5. è§¦å‘ Pod é‡å»º
kubectl delete pod -n kube-system calico-node-c9sgd
```

### âœ… éªŒè¯ç»“æœ
- `crictl pull` æˆåŠŸï¼›
- æ–° Pod çŠ¶æ€å˜ä¸º `Running`ï¼›
- èŠ‚ç‚¹ç½‘ç»œåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚

---

## äº”ã€ç»éªŒæ•™è®­

1. **å®¹å™¨è¿è¡Œæ—¶ä»£ç†é…ç½®å…·æœ‰éšè”½æ€§**  
   - systemd æœåŠ¡çº§çš„ `Environment` ä¸ä¼šåæ˜ åœ¨ç”¨æˆ· shell çš„ `env` ä¸­ï¼›
   - Go ç¼–å†™çš„ç¨‹åºï¼ˆå¦‚ containerdï¼‰ä¼šè¯»å–è¿™äº›ç¯å¢ƒå˜é‡ï¼Œè€Œä¼ ç»Ÿå·¥å…·ï¼ˆå¦‚ curlï¼‰ä¸ä¼šã€‚

2. **å•èŠ‚ç‚¹æ•…éšœä¼˜å…ˆæ’æŸ¥æœ¬åœ°é…ç½®å·®å¼‚**  
   - å½“é›†ç¾¤ä¸­ä»…ä¸€ä¸ªèŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œåº”é‡ç‚¹å¯¹æ¯”å…¶ä¸æ­£å¸¸èŠ‚ç‚¹çš„ï¼š
     - systemd override é…ç½®
     - `.docker/config.json`
     - å®¹å™¨è¿è¡Œæ—¶é…ç½®
     - å†…æ ¸å‚æ•°/ç½‘ç»œç­–ç•¥

3. **ä»£ç†é…ç½®åº”ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…æ‰‹åŠ¨æ®‹ç•™**  
   - ä¸´æ—¶è°ƒè¯•ç”¨çš„ä»£ç†é…ç½®å¿…é¡»åŠæ—¶æ¸…ç†ï¼›
   - å»ºè®®é€šè¿‡åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰å·¥å…·ï¼ˆå¦‚ Ansibleã€Terraformï¼‰ç»Ÿä¸€ç®¡ç†èŠ‚ç‚¹é…ç½®ã€‚

---

## å…­ã€æ”¹è¿›å»ºè®®ï¼ˆPreventionï¼‰

| ç±»åˆ« | å»ºè®® |
|------|------|
| **é…ç½®ç®¡ç†** | ç¦æ­¢æ‰‹åŠ¨ä¿®æ”¹èŠ‚ç‚¹ systemd é…ç½®ï¼›æ‰€æœ‰å˜æ›´éœ€é€šè¿‡ GitOps æˆ–é…ç½®ç®¡ç†å·¥å…·å®æ–½ |
| **é•œåƒç­–ç•¥** | ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ **ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰**ï¼Œé¿å…ç›´æ¥ä¾èµ– `quay.io`ã€`docker.io` ç­‰å…¬ç½‘æº |
| **ç›‘æ§å‘Šè­¦** | å¢åŠ å¯¹ `ImagePullBackOff` äº‹ä»¶çš„ç›‘æ§ï¼ˆå¦‚ Prometheus + kube-state-metrics + Alertmanagerï¼‰ |
| **å¥åº·æ£€æŸ¥** | åœ¨èŠ‚ç‚¹åŠ å…¥é›†ç¾¤å‰ï¼Œæ‰§è¡Œé¢„æ£€è„šæœ¬ï¼Œæ£€æŸ¥ï¼š<br> - containerd æ˜¯å¦èƒ½æ‹‰å–å…³é”®é•œåƒ<br> - æ˜¯å¦å­˜åœ¨æ„å¤–ä»£ç†é…ç½® |
| **æ–‡æ¡£è®°å½•** | å»ºç«‹ã€ŠKubernetes èŠ‚ç‚¹æ ‡å‡†åŒ–é…ç½®æ¸…å•ã€‹ï¼Œæ˜ç¡®ç¦æ­¢é¡¹ä¸å¿…é€‰é¡¹ |

---

## ä¸ƒã€é™„å½•ï¼šå…³é”®å‘½ä»¤é€ŸæŸ¥

```bash
# æŸ¥çœ‹ containerd å®é™…è¿è¡Œç¯å¢ƒ
systemctl show --property=Environment containerd

# æŸ¥çœ‹ systemd override é…ç½®ç›®å½•
ls /etc/systemd/system/containerd.service.d/

# æ‰‹åŠ¨æ‹‰å–é•œåƒï¼ˆéªŒè¯ CRIï¼‰
crictl pull quay.io/calico/cni:v3.31.3

# æ¸…ç†å¡ä½çš„ Pod
kubectl delete pod -n <namespace> <pod-name>
```

---

âœ… **ç»“è®º**ï¼š  
æœ¬æ¬¡æ•…éšœç”± **å•èŠ‚ç‚¹æ®‹ç•™çš„æ— æ•ˆä»£ç†é…ç½®** å¼•èµ·ï¼Œé€šè¿‡ç³»ç»Ÿæ€§å¯¹æ¯”æ’æŸ¥å¿«é€Ÿå®šä½å¹¶ä¿®å¤ã€‚åç»­å¯é€šè¿‡ **æ ‡å‡†åŒ–é…ç½® + ç§æœ‰é•œåƒä»“åº“ + è‡ªåŠ¨åŒ–ç›‘æ§** é¿å…åŒç±»é—®é¢˜å¤å‘ã€‚

--- 
