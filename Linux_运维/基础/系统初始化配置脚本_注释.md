#!/bin/bash

#### 初始化新建 Rocky / Ubuntu 系统
#### 功能：安装工具、修改主机名、设置静态IP、修改网卡名及命名规则、更换软件源

set -e

echo "===== 系统初始化脚本 ====="

#### ---------------------------
#### 检查系统类型
#### ---------------------------

```powershell
if grep -qi rocky /etc/os-release; then
    OS="rocky"
    PKG_MGR="dnf"
elif grep -qi ubuntu /etc/os-release; then
    OS="ubuntu"
    PKG_MGR="apt"
else
    echo "❌ 未知系统，仅支持 Rocky / Ubuntu"
    exit 1
fi
echo "检测到系统：$OS"
```

#### ---------------------------
#### 安装常用工具
#### ---------------------------
```powershell
echo ">>> 检查并安装常用工具..."
TOOLS=("net-tools" "vim" "curl" "wget" "git" )

if [ "$PKG_MGR" = "dnf" ]; then
    for t in "${TOOLS[@]}"; do
        if ! rpm -q $t &>/dev/null; then
            echo "安装 $t..."
            dnf install -y $t
        fi
    done
elif [ "$PKG_MGR" = "apt" ]; then
    apt update -y
    for t in "${TOOLS[@]}"; do
        if ! dpkg -s $t &>/dev/null; then
            echo "安装 $t..."
            apt install -y $t
        fi
    done
fi
```



#### ---------------------------
#### 修改主机名（交互式）
#### ---------------------------
```powershell
read -p "请输入新的主机名: " NEW_HOSTNAME
if [ -n "$NEW_HOSTNAME" ]; then
    hostnamectl set-hostname "$NEW_HOSTNAME"
    echo "主机名已修改为: $NEW_HOSTNAME"
fi
```

#### ---------------------------
#### 修改静态 IP（交互式）
#### ---------------------------
```powershell
read -p "请输入网卡名称(默认eth0): " IFACE
IFACE=${IFACE:-eth0}
read -p "请输入静态IP地址 (例如 192.168.1.100): " IPADDR
read -p "请输入子网掩码 (例如 24): " NETMASK
read -p "请输入网关 (例如 192.168.1.1): " GATEWAY
read -p "请输入DNS (例如 8.8.8.8): " DNS

if [ "$OS" = "rocky" ]; then
    NM_FILE="/etc/NetworkManager/system-connections/${IFACE}.nmconnection"
    nmcli con add type ethernet ifname "$IFACE" con-name "$IFACE" ipv4.method manual ipv4.addresses "$IPADDR/$NETMASK" ipv4.gateway "$GATEWAY" ipv4.dns "$DNS"
    nmcli con up "$IFACE"
elif [ "$OS" = "ubuntu" ]; then
    NETPLAN_FILE="/etc/netplan/01-netcfg.yaml"
    cat > $NETPLAN_FILE <<EOF
network:
  version: 2
  ethernets:
    $IFACE:
      dhcp4: no
      addresses: [$IPADDR/$NETMASK]
      gateway4: $GATEWAY
      nameservers:
        addresses: [$DNS]
EOF
    netplan apply
fi
echo "静态IP已设置完成。"
```

#### ---------------------------
#### 修改网卡名为 eth0

#### ---------------------------

```powershell
echo "===== 修改网卡名为 eth0 ====="
if [ "$OS" = "rocky" ]; then
    
    MAC=$(ip link | awk '/ether/ {print $2; exit}')
    # 取第一个物理网卡的MAC
	# /ether/：匹配包含 ether 的行（即 MAC 地址行）。
	# 加入exit参数，在这里相当于只取第一个网卡的 MAC 地址。
    NIC=$(ip -o link show | awk -F': ' '{print $2}' | grep -E '^(ens|eth)' | head -n1)
	# ip -o link show → 一行显示一个接口
	# grep -E '^(ens|eth)' → 过滤掉 lo 等
	# head -n1 → 取第一块（通常就是默认网卡）
	cd /etc/NetworkManager/system-connections/
	mv $NIC.nmconnection eth0.nmconnection
	sed -i "s@$NIC@eth0@g" /etc/NetworkManager/system-connections/eth0.nmconnection
	sed -i -e 's/GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0"/' -e 's/GRUB_ENABLE_BLSCFG=.*/GRUB_ENABLE_BLSCFG=false/' /etc/default/grub
	# net.ifnames=0和biosdevname=0会禁用systemd/udev的“可预测网卡命名规则”。网卡名回到经典的 eth0、eth1这种原始排序风格。
	# GRUB_ENABLE_BLSCFG=false 禁用 BLS (Boot Loader Specification) 配置，强制 grub 直接使用 /etc/default/grub 的配置。
	# 在 Rocky/CentOS/RHEL 8+ 系列里，默认启用 BLS，但某些 grub 参数（比如上面改的 net.ifnames=0）可能不生效，所以要关掉。
	# /etc/default/grub：grub2 的默认配置文件。
	#	cat >/etc/udev/rules.d/70-persistent-net.rules <<EOF
	#SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="$MAC", NAME="eth0"
	#EOF
	# udev 固定网卡名称。udev 会读取这个规则文件来给网卡分配固定名称。（70-persistent-net.rules这个文件默认没有，自行创建）
	# SUBSYSTEM=="net" → 只匹配网络设备；ACTION=="add" → 只在设备被添加时生效；NAME="eth0" → 只给匹配到的网卡命名为 eth0；ATTR{address}=="$MAC" → 只匹配 MAC地址为$MAC的网卡；在这里是第一块网卡的MAC地址。
	## 重点：这个命令只会作用于第一个网卡（即 $MAC 对应的那块）。且只要这个命令生效，那么第一块网卡名称永远被命令为eth0。而新增网卡不会被这个规则限制，除非你另外写规则匹配它们的 MAC。所以输入这个命令不如在/etc/default/grub中修改配置参数。
	# 在 Rocky 8/9 或 Ubuntu 20.04/24.04 里，有时候 70-persistent-net.rules 被弃用，系统优先使用 predictable naming + grub 参数。
	# 重启或者手动触发 udevudevadm control --reload-rules
	ls /boot/efi
	# 查看系统启动项
    if [ $? -ep 0 ]; then
	grub2-mkconfig -o /boot/efi/EFI/rocky/grub.cfg
	else
	grub2-mkconfig -o  /boot/grub2/grub.cfg
	echo "Rocky 已配置网卡 eth0 (重启后生效)"
elif [ "$OS" = "ubuntu" ]; then
    # 修改 GRUB 参数 net.ifnames=0
    sed -i 's/GRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 /' /etc/default/grub
    update-grub
    echo "Ubuntu 已配置网卡 eth0 (重启后生效)"
fi
```

#### ---------------------------

#### 配置国内源 (阿里源)

#### ---------------------------

```powershell
#!/bin/bash
# Rocky 与 Ubuntu 通用更换软件源脚本

echo ">>> 检测系统类型..."

if [ -f /etc/os-release ]; then
    . /etc/os-release
    # . /etc/os-release 会把这些变量加载到当前 Shell 环境，但不会输出。
    OS=$ID
    VERSION_ID=$VERSION_ID
    # 如上所说，文件中的变量已经加载到当前环境中，再加这两个变量可有可无，但它的最大作用就是提高脚本可读性！
else
    echo "无法检测系统类型"
    exit 1
fi

echo "检测到系统: $OS $VERSION_ID"

# === Rocky Linux 部分 ===
if [ "$OS" = "rocky" ]; then
    echo "检测到 Rocky Linux 系统，正在修改 YUM 源..."
	mkdir bak && mv *.repo bak
    touch  rocky.repo
    A="AppStream"
    B="BaseOS"
    E="epel"
    REPO_FILE="/etc/yum.repos.d/rocky.repo"
    URL_AppStream="https://mirrors.aliyun.com/rockylinux/9/$A/x86_64/os/"
    URL_BESEOS="https://mirrors.aliyun.com/rockylinux/9/$B/x86_64/os/"
    URL_Epel="https://mirrors.aliyun.com/$E/9/Everything/x86_64/"

    if [ ! -f "$REPO_FILE" ]; then
        echo "错误：未找到 $REPO_FILE"
        exit 1
    fi
    
    cat > $REPO_FILE <<EOF
[$B]
name="$NAME"-"$B"
baseurl=$URL_BESEOS
enabled=1
gpgcheck=0

[$A]
name="$NAME"-"$A"
baseurl=$URL_AppStream
enabled=1
gpgcheck=0

[$E]
name="$NAME"-"$E"
baseurl=$URL_Epel
enabled=1
gpgcheck=0
EOF
    
    dnf clean all 
	dnf makecache
	echo "Rocky Linux 软件源已修改为阿里云镜像。"
	
# === ubuntu Linux 部分 ===
if [ "$OS" = "ubuntu" ]; then
	echo "检测到 ubuntu Linux 系统，正在修改 APT 源..."
	ALI="http://mirrors.aliyun.com/ubuntu"
	QingHua="https://mirrors4.tuna.tsinghua.edu.cn/ubuntu/"
	BACKUP="/etc/apt/sources.list.d/ubuntu.sources"
	#在Ubuntu 22.04+默认并不是ubuntu.sources（具体要看系统）。建议加一个检测。
	
    cp "$BACKUP" "$BACKUP"-"$(date +%F)"  
    # 备份原有源列表
	sed -i  "s@URIs:.*@URIs: $ALI@" "$BACKUP"
	
#	if [[ "$VERSION_CODENAME" =~ (noble|jammy|focal) ]]; then 
#		sed -i  "s@$VERSION_CODENAME@jammy@g" "$BACKUP"
		# sed 部分需要改用 双引号，否则变量不会生效。
#	else
#		echo "*****未检测到版本代号*****"
#	fi

	case $VERSION_CODENAME in
		noble|jammy|focal)
		sed -i  "s@$VERSION_CODENAME@jammy@g" "$BACKUP"
		;;
		*)
		echo "***** 未检测到版本代号 *****"
		 ;;
	esac
else
    apt update
fi
```





