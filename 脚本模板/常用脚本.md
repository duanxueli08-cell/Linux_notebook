---
create_time: 2025-12-26 21:45
tags: SRE/Learning
status: ğŸ“ æ²‰æ·€ä¸­â€¦â€¦
copilot-command-context-menu-enabled: true
---

## ğŸ› ï¸ è¿ç»´å®æˆ˜ï¼šå¸¸ç”¨è„šæœ¬

- **å®éªŒæ—¥æœŸ**: 2025-12-26
- **æ“ä½œäººå‘˜**: æ®µå­¦ç«‹ (SRE Engineer)
- **ç¯å¢ƒä¿¡æ¯**: 
    - **OS**: `Ubuntu 2404`
    - **IPåœ°å€**: 10.0.0.101

---

### 1. ğŸ¯ å®éªŒ/æ•…éšœç›®æ ‡
> **åœºæ™¯æè¿°**ï¼šk8s é›†ç¾¤çš„è®¾å¤‡å…³æœºéœ€è¦æ›´åŠ ä¼˜é›…ï¼›
> æœ‰ storageclass nfs åŠ¨æ€å­˜å‚¨çš„ k8s é›†ç¾¤éœ€è¦æè‡´çš„ä¼˜é›…ï¼
> 

### 2. âš¡ å…³æœºè„šæœ¬
```bash
#!/bin/bash
# ----------------------------------------------------------------
# SRE è¿ç»´è€å¸ˆå‡ºå“ï¼šK8s é›†ç¾¤æ™ºèƒ½ä¸‹ç”µè„šæœ¬ (v2.0 ä¿®å¤ç‰ˆ)
# ----------------------------------------------------------------

echo "ğŸš€ [$(date)] å¯åŠ¨é›†ç¾¤å®‰å…¨ä¸‹ç”µç¨‹åº..."

# 1. è·å–æ‰€æœ‰é Master èŠ‚ç‚¹
nodes=$(kubectl get nodes --no-headers | grep -v "control-plane" | grep -v "master" | awk '{print $1}')

for node in $nodes; do
    echo "ğŸ” æ£€æŸ¥èŠ‚ç‚¹ $node çŠ¶æ€..."
    
    # æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿ (ä½¿ç”¨ ping æ¢æµ‹ï¼Œå‰ææ˜¯ä½ çš„èŠ‚ç‚¹ IP èƒ½ ping é€š)
    # è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ kubectl çŠ¶æ€åˆ¤æ–­
    status=$(kubectl get node $node --no-headers | awk '{print $2}')
    
    if [[ "$status" == "Ready" ]]; then
        echo "ğŸ“¦ èŠ‚ç‚¹ $node åœ¨çº¿ï¼Œæ‰§è¡Œä¼˜é›…é©±é€..."
        kubectl drain $node --ignore-daemonsets --delete-emptydir-data --force --timeout=30s
    else
        echo "âš ï¸ èŠ‚ç‚¹ $node çŠ¶æ€ä¸º $status (å¯èƒ½å·²å…³æœº)ï¼Œè·³è¿‡é©±é€é€»è¾‘ã€‚"
    fi
done

# 2. å¦‚æœä½ åªæ˜¯æƒ³å…³ Masterï¼Œæ—¢ç„¶ Worker éƒ½å…³äº†ï¼Œå…¶å®ä¸éœ€è¦ drain äº†
# æˆ‘ä»¬ç›´æ¥æš´åŠ›ä¸€ç‚¹ï¼Œé’ˆå¯¹ä½ ç°åœ¨çš„å®éªŒç¯å¢ƒï¼š
echo "ğŸ›‘ æ­£åœ¨åœæ­¢ Master æ ¸å¿ƒå®¹å™¨è¿è¡Œæ—¶..."
systemctl stop kubelet
systemctl stop docker || systemctl stop containerd

# 3. é‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œé˜²æ­¢ NFS å¥æŸ„æ®‹ç•™
echo "ğŸ’¾ å†™å…¥ç¼“å­˜åˆ°ç£ç›˜ (sync)..."
sync
sleep 2

# 4. çœŸæ­£ä¸‹ç”µ
echo "ğŸ–¥ï¸ æ­£åœ¨å…³é—­ Master ä¸»æœº..."
# åœ¨å®éªŒç¯å¢ƒä¸‹ï¼Œç›´æ¥æ‰§è¡Œå…³æœºå‘½ä»¤å³å¯
/sbin/halt -p

```

- **Sync æ˜¯å¥½ä¹ æƒ¯ï¼š** è„šæœ¬é‡Œé‚£ä¸ª `sync` å‘½ä»¤ï¼Œåœ¨ Linux è¿ç»´é‡Œæ˜¯â€œåœ£ç»â€ã€‚è¿ç»­æ•²ä¸‰æ¬¡ `sync; sync; sync;`ï¼Œé‚£æ˜¯è€è¿ç»´å¯¹æ•°æ®çš„æœ€åæ•¬æ„ã€‚


2. âš¡ ä¸€é”®å¼€æœºå¹¶å¥åº·æ£€æŸ¥
```bash
#!/bin/bash
# ----------------------------------------------------------------
# SRE è¿ç»´è€å¸ˆå‡ºå“ï¼šK8s é›†ç¾¤å¼€æœºå¥åº·ä½“æ£€è„šæœ¬ (v1.0)
# ----------------------------------------------------------------

# å®šä¹‰é¢œè‰²ï¼Œè®©è¾“å‡ºæ›´ç”ŸåŠ¨
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸš€ [$(date)] å¯åŠ¨ K8s é›†ç¾¤å¥åº·æ£€æŸ¥ç¨‹åº...${NC}"

# 1. æ£€æŸ¥ Master æ ¸å¿ƒç»„ä»¶çŠ¶æ€ (Kubelet & Runtime)
echo -e "\nğŸ” [1/5] æ£€æŸ¥ Master åŸºç¡€æœåŠ¡..."
for service in kubelet docker containerd; do
    if systemctl is-active --quiet $service; then
        echo -e "âœ… $service æœåŠ¡è¿è¡Œä¸­"
    else
        echo -e "âš ï¸ $service æœªå¯åŠ¨ï¼Œå°è¯•å¯åŠ¨..."
        systemctl start $service
    fi
done

# 2. æ£€æŸ¥æ‰€æœ‰ Node æ˜¯å¦ Ready
echo -e "\nğŸ” [2/5] æ£€æŸ¥èŠ‚ç‚¹åœ¨çº¿çŠ¶æ€ (ç­‰å¾…èŠ‚ç‚¹ Ready)..."
sleep 5 # ç»™é›†ç¾¤ä¸€ç‚¹ååº”æ—¶é—´
kubectl get nodes
ready_nodes=$(kubectl get nodes | grep -w "Ready" | wc -l)
total_nodes=$(kubectl get nodes --no-headers | wc -l)

if [ "$ready_nodes" -eq "$total_nodes" ]; then
    echo -e "${GREEN}âœ… æ‰€æœ‰èŠ‚ç‚¹ ($ready_nodes/$total_nodes) å·²è¿›å…¥ Ready çŠ¶æ€ï¼${NC}"
else
    echo -e "${RED}âŒ è­¦å‘Šï¼šæœ‰èŠ‚ç‚¹å¤„äº NotReady çŠ¶æ€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Worker å¼€å¯æƒ…å†µã€‚${NC}"
fi

# 3. æ£€æŸ¥ NFS å­˜å‚¨æŒ‚è½½æƒ…å†µ (SRE æœ€å…³å¿ƒçš„ç‚¹)
echo -e "\nğŸ” [3/5] æ£€æŸ¥ NFS æŒ‚è½½çŠ¶æ€..."
if mount | grep -q "type nfs"; then
    echo -e "${GREEN}âœ… å‘ç° NFS æŒ‚è½½ç‚¹ï¼Œå­˜å‚¨è·¯å¾„æ­£å¸¸ã€‚${NC}"
else
    echo -e "${YELLOW}âš ï¸ æœªå‘ç° NFS æŒ‚è½½ï¼Œå¦‚æœæ˜¯åŠ¨æ€å­˜å‚¨ï¼Œè¯·è§‚å¯Ÿ Pod å¯åŠ¨æƒ…å†µã€‚${NC}"
fi

# 4. æ£€æŸ¥æ ¸å¿ƒ Pod (å¦‚ Flannel, CoreDNS)
echo -e "\nğŸ” [4/5] æ£€æŸ¥ç³»ç»Ÿå…³é”® Pod çŠ¶æ€..."
unhealthy_pods=$(kubectl get pods -A --field-selector status.phase!=Running,status.phase!=Succeeded --no-headers | grep -v "Terminating")

if [ -z "$unhealthy_pods" ]; then
    echo -e "${GREEN}âœ… æ‰€æœ‰ç³»ç»Ÿ Pod è¿è¡Œæ­£å¸¸ã€‚${NC}"
else
    echo -e "${RED}âŒ å‘ç°å¼‚å¸¸ Podï¼š${NC}"
    echo "$unhealthy_pods"
fi

# 5. è‡ªåŠ¨æ¢å¤ï¼šå¦‚æœä½ ä¹‹å‰ä¸ºäº†å…³æœºæŠŠå‰¯æœ¬æ•°ç¼©åˆ°äº† 0ï¼Œè¿™é‡Œå¯ä»¥ä¸€é”®æ¢å¤
# è€å¸ˆè¿™é‡Œå†™ä¸ªé€»è¾‘ï¼šå¦‚æœå‘ç°æŸå‘½åç©ºé—´ä¸‹å‰¯æœ¬ä¸º 0ï¼Œæç¤ºä½ å¯ä»¥æ¢å¤
echo -e "\nğŸ” [5/5] ä¸šåŠ¡æ¢å¤æç¤º..."
echo "ğŸ’¡ å¦‚æœä½ ä¹‹å‰ç¼©å®¹äº† Deploymentï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œï¼š"
echo "   kubectl scale deployment <name> --replicas=3 -n <namespace>"

echo -e "\n${GREEN}âœ¨ [$(date)] ä½“æ£€ç»“æŸï¼${NC}"
```

- **NFS çš„â€œæ—¶é—´å·®â€ï¼š** è¿™æ˜¯æœ€å®¹æ˜“ç¿»è½¦çš„åœ°æ–¹ï¼å¦‚æœä½ çš„ NFS Server å¯åŠ¨æ…¢äº†ï¼ŒWorker èŠ‚ç‚¹çš„ `kubelet` å¯èƒ½ä¼šå› ä¸ºæŒ‚è½½å¤±è´¥è€Œæ”¾å¼ƒï¼Œå¯¼è‡´ Pod ä¸€ç›´å¤„äº `ContainerCreating` æˆ–è€… `Error`ã€‚
    
    - **åº”å¯¹ï¼š** å…ˆå¼€å­˜å‚¨ï¼Œç¡®è®¤ `showmount -e <NFS_IP>` èƒ½çœ‹åˆ°å…±äº«ç›®å½•äº†ï¼Œå†å¼€ Workerã€‚
        
- **æœ‰çŠ¶æ€æœåŠ¡çš„â€œæ®‹ç•™é”â€ï¼š** åƒä½ çš„ `myharbor-database`ã€‚æœ‰æ—¶å€™æ„å¤–å…³æœºé‡å¯ï¼Œæ•°æ®åº“ä¼šå› ä¸ºå‘ç° `lock` æ–‡ä»¶è€Œå¯åŠ¨å¤±è´¥ã€‚å¦‚æœä½“æ£€è„šæœ¬å‘ç°æ•°æ®åº“ Pod æŠ¥é”™ï¼Œè®°å¾—å»çœ‹æ—¥å¿—ï¼ˆ`kubectl logs`ï¼‰ã€‚
- ç½‘å…³ä¸é€šä¸‡äº‹çš†ä¼‘ã€‚å¼€æœºåå¦‚æœ Node çŠ¶æ€æ˜¯ `NotReady`ï¼Œç¬¬ä¸€ä¸ªå‘½ä»¤åº”è¯¥æ˜¯ `ip addr` çœ‹çœ‹ä½ çš„ `flannel` è™šæ‹Ÿç½‘å¡èµ·æ¥æ²¡ã€‚