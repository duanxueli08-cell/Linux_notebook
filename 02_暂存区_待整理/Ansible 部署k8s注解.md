

### ç¬¬ä¸€é˜¶æ®µï¼š

### æ§åˆ¶ç«¯è¯ä¹¦ã€é…ç½®ä¸ç¯å¢ƒå‡†å¤‡ (`PLAY [localhost]`)

è¿™ä¸ªé˜¶æ®µæ‰€æœ‰æ“ä½œéƒ½åœ¨ Ansible **æ§åˆ¶ç«¯ (localhost)** è¿›è¡Œï¼Œä¸»è¦ç›®çš„æ˜¯ç”Ÿæˆ Kubernetes é›†ç¾¤æ‰€éœ€çš„å„ç§è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼Œå¹¶å‡†å¤‡å·¥å…·ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                         | **æ ¸å¿ƒåŠŸèƒ½**             | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| `prepare some dirs`                                          | **åˆ›å»ºæœ¬åœ°é›†ç¾¤ç›®å½•**     | åœ¨ `/etc/kubeasz/clusters/k8s-01/` ä¸‹åˆ›å»º `ssl/`ã€`backup/`ã€`yml/` ç­‰ç›®å½•ã€‚**è¿™æ˜¯æ‚¨è§£å†³è¯ä¹¦é—®é¢˜çš„å…³é”®ä¸€æ­¥**ã€‚ |
| `å‡†å¤‡CAé…ç½®æ–‡ä»¶å’Œç­¾åè¯·æ±‚`                                   | å‡†å¤‡è¯ä¹¦ç­¾åé…ç½®æ–‡ä»¶     | åˆ›å»º `ca-config.json`, `ca-csr.json`ã€‚                       |
| `ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥`                                         | **ç”Ÿæˆæ ¹è¯ä¹¦**           | ç”Ÿæˆ `ca.pem` å’Œ `ca-key.pem`ï¼Œç”¨äºåç»­ç­¾å‘æ‰€æœ‰ç»„ä»¶è¯ä¹¦ã€‚    |
| `å‡†å¤‡/åˆ›å»º admin è¯ä¹¦ä¸ç§é’¥`                                 | ç”Ÿæˆç®¡ç†è¯ä¹¦             | ç”Ÿæˆ `admin.pem` å’Œ `admin-key.pem`ï¼Œç”¨äº `kubectl` è®¿é—®é›†ç¾¤ã€‚ |
| `è®¾ç½®é›†ç¾¤/å®¢æˆ·ç«¯/ä¸Šä¸‹æ–‡å‚æ•°`                                 | **ç”Ÿæˆ kubeconfig æ–‡ä»¶** | é…ç½®é›†ç¾¤è¿æ¥ä¿¡æ¯å’Œè®¤è¯å‡­è¯ã€‚                                 |
| `å®‰è£…kubeconfig`                                             | å¤åˆ¶ `kubeconfig`        | å°†ç”Ÿæˆçš„ `~/.kube/config` å¤åˆ¶åˆ°æœ¬åœ°ã€‚                       |
| `å‡†å¤‡/åˆ›å»º kube-proxy`, `kube-controller-manager`, `kube-scheduler` è¯ä¹¦ | **ç”Ÿæˆç»„ä»¶è¯ä¹¦**         | ä¸º Kubernetes çš„æ ¸å¿ƒç»„ä»¶ç”Ÿæˆæ‰€éœ€çš„è¯ä¹¦å’Œç§é’¥ã€‚               |
| `æœ¬åœ°åˆ›å»º ezdown/ezctl å·¥å…·çš„è½¯è¿æ¥`                         | æ–¹ä¾¿æœ¬åœ°ç®¡ç†             | ç®€åŒ–å‘½ä»¤è¡Œæ“ä½œã€‚                                             |



### ç¬¬äºŒé˜¶æ®µï¼š

### é›†ç¾¤èŠ‚ç‚¹ç¯å¢ƒå‡†å¤‡ (`PLAY [kube_master,kube_node,etcd]`)

è¿™ä¸ªé˜¶æ®µçš„æ“ä½œåœ¨é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆMasterã€Nodeã€Etcdï¼‰ä¸Šæ‰§è¡Œï¼Œä¸»è¦ç›®çš„æ˜¯è¿›è¡Œæ“ä½œç³»ç»Ÿå±‚é¢çš„ä¼˜åŒ–å’Œç¯å¢ƒåˆå§‹åŒ–ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                         | **æ ¸å¿ƒåŠŸèƒ½**          | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ------------------------------------------------------------ | --------------------- | ------------------------------------------------------------ |
| `aptæ›´æ–°ç¼“å­˜/å®‰è£…åŸºç¡€è½¯ä»¶/ä¼˜åŒ– journal æ—¥å¿—`                 | åŸºç¡€ç¯å¢ƒè®¾ç½®          | ä¿è¯èŠ‚ç‚¹ç¯å¢ƒä¸€è‡´ï¼Œå¹¶ä¼˜åŒ–ç³»ç»Ÿæ—¥å¿—ã€‚                           |
| `ç¦ç”¨ç³»ç»Ÿ swap / åˆ é™¤fstab swap ç›¸å…³é…ç½®`                    | **K8s å¿…å¤‡è¦æ±‚**      | Kubernetes è¦æ±‚ç¦ç”¨ Swapã€‚                                   |
| `åŠ è½½å†…æ ¸æ¨¡å— / å¯ç”¨systemdè‡ªåŠ¨åŠ è½½æ¨¡å—æœåŠ¡`                 | **ç½‘ç»œ/å­˜å‚¨æ¨¡å—å‡†å¤‡** | åŠ è½½ `br_netfilter`, `ip_vs` ç³»åˆ—ç­‰å†…æ ¸æ¨¡å—ï¼Œä¸º K8s çš„ç½‘ç»œå’Œè´Ÿè½½å‡è¡¡åšå‡†å¤‡ã€‚ |
| `è®¾ç½®ç³»ç»Ÿå‚æ•°`                                               | **å†…æ ¸å‚æ•°ä¼˜åŒ–**      | è®¾ç½® `sysctl.conf` å‚æ•°ï¼Œå¦‚ç½‘ç»œå’Œå†…å­˜ç›¸å…³ï¼Œå¹¶ä½¿å…¶ç”Ÿæ•ˆã€‚      |
| `prepare some dirs`                                          | **è¿œç¨‹èŠ‚ç‚¹ç›®å½•å‡†å¤‡**  | åœ¨æ‰€æœ‰èŠ‚ç‚¹åˆ›å»º `/opt/kube/bin` å’Œ `/etc/kubernetes/ssl` ç­‰ K8s è¿è¡Œç›®å½•ã€‚ |
| `å¤åˆ¶kubectl kubeconfig`                                     | **åˆ†å‘ç®¡ç†é…ç½®**      | å°†ç¬¬ä¸€é˜¶æ®µç”Ÿæˆçš„ `kubectl` é…ç½®åˆ†å‘åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ–¹ä¾¿èŠ‚ç‚¹ä¸Šçš„å‘½ä»¤è¡Œæ“ä½œã€‚ |
| `è®¾ç½®èŠ‚ç‚¹ hostname / è®¾ç½® k8s_nodename åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„ /etc/hosts åœ°å€è§£æ` | **èŠ‚ç‚¹é—´é€šä¿¡é…ç½®**    | ç¡®ä¿èŠ‚ç‚¹é—´å¯ä»¥é€šè¿‡ä¸»æœºåæ­£ç¡®è§£æ IP åœ°å€ï¼Œåˆ©äºé›†ç¾¤å†…éƒ¨é€šä¿¡ã€‚ |



### ç¬¬ä¸‰é˜¶æ®µï¼š

### Etcd éƒ¨ç½² (`PLAY [etcd]`)

æ­¤é˜¶æ®µä¸“æ³¨äº Etcd é›†ç¾¤çš„éƒ¨ç½²å’Œå¯åŠ¨ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                     | **æ ¸å¿ƒåŠŸèƒ½**       | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ---------------------------------------- | ------------------ | ------------------------------------------------------------ |
| `ä¸‹è½½etcdäºŒè¿›åˆ¶æ–‡ä»¶`                     | å‡†å¤‡å¯æ‰§è¡Œæ–‡ä»¶     | å°† `etcd` å’Œ `etcdctl` æ”¾åˆ° `/opt/kube/bin` ç›®å½•ã€‚           |
| `åˆ›å»ºetcdè¯ä¹¦è¯·æ±‚ / åˆ›å»º etcdè¯ä¹¦å’Œç§é’¥` | **ç”Ÿæˆ Etcd è¯ä¹¦** | åœ¨æ§åˆ¶ç«¯ä½¿ç”¨ CA è¯ä¹¦ç­¾å‘ Etcd èŠ‚ç‚¹æ‰€éœ€çš„è¯ä¹¦ã€‚               |
| `åˆ†å‘etcdè¯ä¹¦ç›¸å…³`                       | **åˆ†å‘è¯ä¹¦**       | å°† `ca.pem`, `etcd.pem`, `etcd-key.pem` åˆ†å‘åˆ° Etcd èŠ‚ç‚¹ï¼ˆ`/etc/kubernetes/ssl` ç›®å½•ï¼‰ã€‚ |
| `åˆ›å»ºetcdçš„systemd unitæ–‡ä»¶`             | é…ç½®æœåŠ¡ç®¡ç†       | åˆ›å»º Etcd çš„ systemd å¯åŠ¨æ–‡ä»¶ã€‚                              |
| `å¼€æœºå¯ç”¨/å¼€å¯etcdæœåŠ¡`                  | **å¯åŠ¨ Etcd**      | å¯åŠ¨ Etcd æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯ã€‚                               |
| `ä»¥è½®è¯¢çš„æ–¹å¼ç­‰å¾…æœåŠ¡åŒæ­¥å®Œæˆ`           | é›†ç¾¤å¥åº·æ£€æŸ¥       | ç¡®ä¿ Etcd é›†ç¾¤æˆå‘˜ï¼ˆè‡³å°‘ä¸‰ä¸ªèŠ‚ç‚¹ï¼‰éƒ½æˆåŠŸå¯åŠ¨å¹¶ç›¸äº’åŒæ­¥ã€‚     |



### ç¬¬å››é˜¶æ®µï¼š

### Containerd è¿è¡Œæ—¶éƒ¨ç½² (`PLAY [kube_master,kube_node]`)

æ­¤é˜¶æ®µåœ¨æ‰€æœ‰ Master å’Œ Node èŠ‚ç‚¹ä¸Šéƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶ **Containerd**ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                         | **æ ¸å¿ƒåŠŸèƒ½**             | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| `å‡†å¤‡containerdç›¸å…³ç›®å½•`                                     | åˆ›å»º containerd é…ç½®ç›®å½• | åˆ›å»º `/etc/containerd` å’Œç›¸å…³çš„é•œåƒä»“åº“é…ç½®ç›®å½•ã€‚            |
| `åŠ è½½å†…æ ¸æ¨¡å— overlay`                                       | å­˜å‚¨é©±åŠ¨æ”¯æŒ             | åŠ è½½ `overlay` æ¨¡å—ï¼Œé€šå¸¸ä½œä¸ºå®¹å™¨çš„å­˜å‚¨é©±åŠ¨ã€‚                |
| `ä¸‹è½½ containerd äºŒè¿›åˆ¶æ–‡ä»¶`                                 | å‡†å¤‡å¯æ‰§è¡Œæ–‡ä»¶           | ä¸‹è½½ `containerd`, `runc`, `ctr` ç­‰æ ¸å¿ƒç»„ä»¶ã€‚                |
| `ä¸‹è½½ crictl`                                                | å®¹å™¨è¿è¡Œæ—¶æ¥å£å·¥å…·       | å‡†å¤‡ç”¨äºè°ƒè¯•å’Œç®¡ç†å®¹å™¨çš„ `crictl` å·¥å…·ã€‚                     |
| `åˆ›å»º containerd é…ç½®æ–‡ä»¶`                                   | **é…ç½® containerd**      | ç”Ÿæˆ `config.toml` æ–‡ä»¶ï¼Œé…ç½® Cgroup é©±åŠ¨ã€Systemd é›†æˆã€Sandbox Image ç­‰ã€‚ |
| `é…ç½®docker.io åŠ é€Ÿé•œåƒ / local_registry ä»“åº“ / harbor ä»“åº“` | é•œåƒæ‹‰å–ä¼˜åŒ–             | é…ç½®é•œåƒåŠ é€Ÿå’Œç§æœ‰ä»“åº“è®¤è¯ã€‚                                 |
| `åˆ›å»ºsystemd unitæ–‡ä»¶ / å¼€æœºå¯ç”¨ containerd æœåŠ¡`            | **å¯åŠ¨ Containerd**      | å¯åŠ¨å®¹å™¨è¿è¡Œæ—¶æœåŠ¡ã€‚                                         |



### ç¬¬äº”é˜¶æ®µï¼š

### Kube-Node ç»„ä»¶éƒ¨ç½²ä¸è´Ÿè½½å‡è¡¡é…ç½® (`PLAY [kube_node]`)

è¿™ä¸ªé˜¶æ®µé›†ä¸­åœ¨ Worker èŠ‚ç‚¹ï¼ˆ104, 105, 106ï¼‰ä¸Šéƒ¨ç½²å…³é”®çš„ Kubernetes èŠ‚ç‚¹ç»„ä»¶ï¼ˆKubelet å’Œ Kube-Proxyï¼‰ï¼Œå¹¶é…ç½®ç”¨äºè®¿é—® Master æœåŠ¡çš„æœ¬åœ°è´Ÿè½½å‡è¡¡å™¨ï¼ˆ`kube-lb`ï¼‰ã€‚

Kube-LoadBalancer (kube-lb) éƒ¨ç½²

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                               | **æ ¸å¿ƒåŠŸèƒ½**          | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| -------------------------------------------------- | --------------------- | ------------------------------------------------------------ |
| `prepare some dirs / ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶kube-lb(nginx)` | å‡†å¤‡è´Ÿè½½å‡è¡¡å™¨ç¯å¢ƒ    | åˆ›å»ºé…ç½®ç›®å½• (`/etc/kube-lb/conf`) å¹¶ä¸‹è½½ `kube-lb`ï¼ˆåŸºäº Nginx æˆ–ç±»ä¼¼çš„è½»é‡çº§ LoadBalancerï¼‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ |
| `åˆ›å»º/å¯ç”¨/å¼€å¯kube-lbæœåŠ¡`                        | **éƒ¨ç½² LoadBalancer** | åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œé…ç½®ç›‘å¬åœ°å€å’Œåç«¯ Master èŠ‚ç‚¹åˆ—è¡¨ï¼Œç„¶åä»¥ systemd æœåŠ¡çš„å½¢å¼å¯åŠ¨ã€‚ |
| `ä»¥è½®è¯¢çš„æ–¹å¼ç­‰å¾…kube-lbæœåŠ¡å¯åŠ¨`                  | æœåŠ¡å¥åº·æ£€æŸ¥          | ç¡®ä¿æœ¬åœ°è´Ÿè½½å‡è¡¡å™¨è¿è¡Œæ­£å¸¸ï¼Œå®ƒå°†è´Ÿè´£å°† Kubelet ç­‰ç»„ä»¶çš„è¯·æ±‚è½¬å‘ç»™å¥åº·çš„ API Serverã€‚ |

Kube-Node æ ¸å¿ƒç»„ä»¶éƒ¨ç½² (Kubelet & Kube-Proxy)

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                         | **æ ¸å¿ƒåŠŸèƒ½**             | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| `åˆ›å»ºkube_node ç›¸å…³ç›®å½•`                                     | èŠ‚ç‚¹ç»„ä»¶ç›®å½•å‡†å¤‡         | åˆ›å»º `/var/lib/kubelet`, `/var/lib/kube-proxy` å’Œ CNI æ’ä»¶ç›®å½• (`/etc/cni/net.d`, `/opt/cni/bin`)ã€‚ |
| `ä¸‹è½½ kubelet,kube-proxy äºŒè¿›åˆ¶ / ä¸‹è½½ cni plugins äºŒè¿›åˆ¶æ–‡ä»¶` | **ç»„ä»¶äºŒè¿›åˆ¶å‡†å¤‡**       | å°† `kubelet` å’Œ `kube-proxy` å¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠæ‰€æœ‰æ ‡å‡†çš„ CNI æ’ä»¶ï¼ˆå¦‚ `bridge`, `host-local`, `portmap` ç­‰ï¼‰åˆ†å‘åˆ°èŠ‚ç‚¹ã€‚ |
| `å‡†å¤‡/åˆ›å»º kubelet è¯ä¹¦ä¸ç§é’¥`                               | **Kubelet è¯ä¹¦ç”Ÿæˆ**     | ä¸ºæ¯ä¸ª Kubelet èŠ‚ç‚¹ç”Ÿæˆå”¯ä¸€çš„ TLS è¯ä¹¦ã€‚                     |
| `è®¾ç½®é›†ç¾¤å‚æ•° / åˆ†å‘ca è¯ä¹¦ / åˆ†å‘kubelet è¯ä¹¦ / åˆ†å‘kubeconfig` | **é…ç½® Kubelet è®¤è¯**    | ä½¿ç”¨æ–°è¯ä¹¦å’Œé›†ç¾¤ä¿¡æ¯é…ç½® Kubelet çš„ `kubeconfig` æ–‡ä»¶ã€‚      |
| `åˆ›å»ºkubeletçš„é…ç½®æ–‡ä»¶ / systemd unitæ–‡ä»¶ / å¼€å¯kubelet æœåŠ¡` | **å¯åŠ¨ Kubelet**         | å¯åŠ¨ Kubelet æœåŠ¡ï¼Œå®ƒæ˜¯èŠ‚ç‚¹ä¸Šçš„æ ¸å¿ƒä»£ç†ï¼Œè´Ÿè´£ä¸ Master é€šä¿¡å¹¶ç®¡ç† Podã€‚ |
| `åˆ†å‘ kube-proxy.kubeconfigé…ç½®æ–‡ä»¶ / æ›¿æ¢ apiserver åœ°å€`   | **é…ç½® Kube-Proxy è®¤è¯** | é…ç½® Kube-Proxy çš„è®¤è¯ä¿¡æ¯ï¼Œå¹¶å°†å…¶ API Server åœ°å€æŒ‡å‘æœ¬åœ°çš„ `kube-lb` åœ°å€ã€‚ |
| `åˆ›å»ºkube-proxy é…ç½® / æœåŠ¡æ–‡ä»¶ / å¼€å¯kube-proxy æœåŠ¡`       | **å¯åŠ¨ Kube-Proxy**      | å¯åŠ¨ Kube-Proxy æœåŠ¡ï¼Œè´Ÿè´£å®ç° Service çš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡ã€‚ |
| `è½®è¯¢ç­‰å¾…kube-proxy/kubeletå¯åŠ¨ / è½®è¯¢ç­‰å¾…nodeè¾¾åˆ°ReadyçŠ¶æ€` | **èŠ‚ç‚¹å¥åº·æ£€æŸ¥**         | ç¡®è®¤ Kubelet å’Œ Kube-Proxy æ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸”èŠ‚ç‚¹åœ¨ API Server ä¸­æ³¨å†Œå¹¶è¿›å…¥ `Ready` çŠ¶æ€ã€‚ |
| `Setting worker role name`                                   | èŠ‚ç‚¹è§’è‰²æ ‡è®°             | ä¸ºèŠ‚ç‚¹è®¾ç½® `worker` è§’è‰²æ ‡ç­¾ã€‚                               |



### ç¬¬å…­é˜¶æ®µï¼š

### ç½‘ç»œæ’ä»¶ Calico éƒ¨ç½² (`PLAY [kube_master,kube_node]`)

æ­¤é˜¶æ®µåœ¨æ‰€æœ‰ Master å’Œ Node èŠ‚ç‚¹ä¸Šéƒ¨ç½² Calico ç½‘ç»œæ’ä»¶ï¼Œä»¥æä¾› Pod é—´çš„ç½‘ç»œè¿é€šæ€§ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                    | **æ ¸å¿ƒåŠŸèƒ½**        | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| ------------------------------------------------------- | ------------------- | ------------------------------------------------------------ |
| `åˆ›å»ºcalico è¯ä¹¦è¯·æ±‚ / åˆ›å»º calicoè¯ä¹¦å’Œç§é’¥`           | **Calico è¯ä¹¦ç”Ÿæˆ** | Calico éœ€è¦è¯ä¹¦è¿æ¥ Etcdï¼ˆå¦‚æœæ‚¨ä½¿ç”¨ Etcd å­˜å‚¨ Calico é…ç½®ï¼‰ã€‚ |
| `åˆ é™¤æ—§ calico-etcd-secrets / åˆ›å»º calico-etcd-secrets` | **K8s Secret é…ç½®** | å°† Calico è¯ä¹¦æ‰“åŒ…æˆ Kubernetes Secretï¼Œä¾› Calico Pod ä½¿ç”¨ã€‚ |
| `é…ç½® calico DaemonSet yamlæ–‡ä»¶ / è¿è¡Œ calicoç½‘ç»œ`      | **éƒ¨ç½² Calico**     | ä½¿ç”¨ `kubectl apply` å‘½ä»¤éƒ¨ç½² Calico çš„ **DaemonSet** å’Œç›¸å…³èµ„æºï¼Œç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œ Calico Agentã€‚ |
| `åœ¨èŠ‚ç‚¹åˆ›å»ºç›¸å…³ç›®å½• / åˆ†å‘calicoè¯ä¹¦ç›¸å…³`               | è¿œç¨‹è¯ä¹¦å‡†å¤‡        | åœ¨èŠ‚ç‚¹ä¸Šåˆ›å»º Calico SSL ç›®å½•å¹¶åˆ†å‘è¯ä¹¦ã€‚                     |
| `åˆ é™¤é»˜è®¤cnié…ç½®`                                       | æ¸…ç†æ—§ CNI é…ç½®     | ç§»é™¤å¯èƒ½å­˜åœ¨çš„é»˜è®¤ CNI é…ç½®æ–‡ä»¶ï¼Œç¡®ä¿ Calico æ¥ç®¡ç½‘ç»œã€‚      |
| `ä¸‹è½½calicoctl å®¢æˆ·ç«¯ / å‡†å¤‡ calicoctlé…ç½®æ–‡ä»¶`         | Calico ç®¡ç†å·¥å…·å‡†å¤‡ | éƒ¨ç½² `calicoctl` å·¥å…·ï¼Œç”¨äº Calico ç½‘ç»œçš„ç®¡ç†å’Œè°ƒè¯•ã€‚        |
| `è½®è¯¢ç­‰å¾…calico-node è¿è¡Œ`                              | **ç½‘ç»œå¥åº·æ£€æŸ¥**    | ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹çš„ `calico-node` Pod å‡å·²æˆåŠŸå¯åŠ¨å¹¶è¿è¡Œã€‚        |



### ç¬¬ä¸ƒé˜¶æ®µï¼š

### é›†ç¾¤é™„åŠ ç»„ä»¶éƒ¨ç½² (`PLAY [localhost]`)

è¿™ä¸ªæœ€åçš„é˜¶æ®µåœ¨ Ansible **æ§åˆ¶ç«¯ (localhost)** è¿›è¡Œï¼Œä½¿ç”¨ `kubectl` å‘½ä»¤éƒ¨ç½²æ ¸å¿ƒçš„é›†ç¾¤æ’ä»¶ã€‚

| **ä»»åŠ¡ (TASK) æ‘˜è¦**                                      | **æ ¸å¿ƒåŠŸèƒ½**            | **å…³é”®è¾“å‡º/ä½œç”¨**                                            |
| --------------------------------------------------------- | ----------------------- | ------------------------------------------------------------ |
| `è·å–æ‰€æœ‰å·²ç»åˆ›å»ºçš„PODä¿¡æ¯`                               | çŠ¶æ€æ£€æŸ¥/å‡†å¤‡å·¥ä½œ       | ç¡®ä¿é›†ç¾¤å¤„äºå¯éƒ¨ç½²æ’ä»¶çš„çŠ¶æ€ã€‚                               |
| `å‡†å¤‡ DNSçš„éƒ¨ç½²æ–‡ä»¶ / åˆ›å»ºcorednséƒ¨ç½²`                    | **éƒ¨ç½² CoreDNS**        | éƒ¨ç½²é›†ç¾¤ DNS æœåŠ¡ï¼Œè¿™æ˜¯ K8s æœåŠ¡å‘ç°çš„æ ¸å¿ƒã€‚                 |
| `å‡†å¤‡dnscacheçš„éƒ¨ç½²æ–‡ä»¶ / åˆ›å»ºdnscacheéƒ¨ç½²`               | éƒ¨ç½² DNS ç¼“å­˜ï¼ˆå¯é€‰ï¼‰   | éƒ¨ç½² DNS ç¼“å­˜ Podï¼Œä¼˜åŒ–é›†ç¾¤å†…éƒ¨ DNS è§£ææ€§èƒ½ã€‚               |
| `å‡†å¤‡ metrics-serverçš„éƒ¨ç½²æ–‡ä»¶ / åˆ›å»º metrics-serveréƒ¨ç½²` | **éƒ¨ç½² Metrics Server** | éƒ¨ç½² `metrics-server`ï¼Œä¸º `kubectl top` å‘½ä»¤å’Œ HPA (Horizontal Pod Autoscaler) æä¾›èµ„æºæŒ‡æ ‡æ•°æ®ã€‚ |



### éƒ¨ç½²æˆåŠŸæ€»ç»“

æœ€ç»ˆçš„ `PLAY RECAP` æ˜¾ç¤ºæ‰€æœ‰ä¸»æœºçš„ `failed=0`ï¼Œè¡¨æ˜æ•´ä¸ªäºŒè¿›åˆ¶éƒ¨ç½²è¿‡ç¨‹**å®Œç¾æˆåŠŸ**ã€‚

```powershell
/etc/cni

/etc/kubeasz/clusters/k8s-01/ssl

/opt/kube/bin

/root/.kube

```



------



ä¸‹é¢æˆ‘ç»™ä½ **é€ä¸ªè®²æ¸…æ¥š 7 ä¸ª YAMLï¼ˆ01 ~ 07ï¼‰åˆ†åˆ«å¹²äº†ä»€ä¹ˆ**ï¼Œç„¶åå†ç»™ä½ ä¸€ä¸ª**æ•´ä½“æµç¨‹æ€»è§ˆ**ï¼Œè®©ä½ ä¸€çœ¼å°±èƒ½çœ‹æ‡‚ kubeasz çš„äºŒè¿›åˆ¶éƒ¨ç½²åˆ°åº•æ˜¯æ€ä¹ˆè·‘èµ·æ¥çš„ã€‚

æˆ‘ä¼šç”¨**æŠ€æœ¯ç›´è¯´ + ä½ èƒ½ç«‹å³ç†è§£çš„ç»“æ„åŒ–æ€»ç»“**ï¼Œä¸æ•´èŠ±é‡Œèƒ¡å“¨ã€‚

------



### âœ… **01.prepare.yml â€” å‡†å¤‡é˜¶æ®µ****ï¼ˆç³»ç»Ÿåˆå§‹åŒ– + CA è¯ä¹¦ç”Ÿæˆï¼‰**

è¿™ä¸ª playbook åšä¸‰ä»¶å¤§äº‹ï¼š

**1ï¼‰èŠ‚ç‚¹ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆæ‰€æœ‰ masterã€nodeã€etcd èŠ‚ç‚¹ï¼‰**

åŒ…æ‹¬ï¼š

- å…³é—­ swap
- å†…æ ¸å‚æ•°ä¼˜åŒ–
- åˆ›å»ºæ‰€éœ€ç›®å½•
- å¼€å¯å†…æ ¸æ¨¡å—
- sysctl ç½‘ç»œä¼˜åŒ–
- æ—¶é’ŸåŒæ­¥ï¼ˆå¯é€‰ chronyï¼‰

> è¿™äº›å°±æ˜¯æ­£å¼è·‘ k8s ä¹‹å‰å¿…é¡»å®Œæˆçš„åŸºç¡€ç¯å¢ƒå‡†å¤‡ã€‚

------

**2ï¼‰æœ¬åœ°ç”Ÿæˆæ‰€æœ‰ Kubernetes è¯ä¹¦ä¸ kubeconfigï¼ˆæœ¬åœ° localhost æ‰§è¡Œï¼‰**

deploy è§’è‰²è´Ÿè´£ç”Ÿæˆï¼š

- CA è¯ä¹¦
- apiserver è¯ä¹¦
- controller-managerã€schedulerã€kubeletã€kube-proxy çš„ kubeconfig
- service-account å¯†é’¥

> è¿™æ˜¯ kubeasz ä¸­æœ€å…³é”®çš„æ­¥éª¤ä¹‹ä¸€ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½ç”¨è¿™æ‰¹è¯ä¹¦ã€‚

------

**3ï¼‰å°†å‡†å¤‡å¥½çš„é…ç½®æ–‡ä»¶åˆ†å‘åˆ°æ‰€æœ‰èŠ‚ç‚¹**

prepare è§’è‰²ï¼š

- åˆ†å‘è¯ä¹¦
- åˆ†å‘ kubeconfig
- åˆ†å‘åŸºç¡€é…ç½®æ–‡ä»¶

------

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šèŠ‚ç‚¹ç³»ç»Ÿå‡†å¤‡ + è¯ä¹¦ç”Ÿæˆ + kubeconfig åˆ†å‘ã€‚**

------

âœ… **02.etcd.yml â€” å®‰è£…ä¸é…ç½® Etcd é›†ç¾¤**

å¯¹ etcd ç»„çš„èŠ‚ç‚¹æ‰§è¡Œï¼š

- åˆ›å»º etcd ç”¨æˆ·ä¸ç›®å½•
- åˆ†å‘ CA ä¸ etcd ä¸“ç”¨è¯ä¹¦
- æ¨é€ etcd å¯åŠ¨æ–‡ä»¶ã€é…ç½®æ–‡ä»¶
- å¯åŠ¨ etcd æœåŠ¡
- æ£€æŸ¥ etcd é›†ç¾¤çŠ¶æ€

> æ•´ä¸ª k8s æ§åˆ¶å¹³é¢çš„æ•°æ®åº“ï¼Œå°±æ˜¯è¿™é‡Œæ­èµ·æ¥çš„ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šå®‰è£…å¹¶å¯åŠ¨ etcd é›†ç¾¤ï¼Œç¡®ä¿ leader æ­£å¸¸ã€‚**

------

### âœ… **03.runtime.yml â€” å®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼ˆcontainerd æˆ– dockerï¼‰**

å¯¹ master å’Œ node æ‰§è¡Œï¼š

- å®‰è£… containerd æˆ– Dockerï¼ˆäºŒé€‰ä¸€ï¼‰
- é…ç½® daemon.json æˆ– containerd config.toml
- é…ç½® CGroup é©±åŠ¨ï¼ˆsystemdï¼‰
- é…ç½® registry mirrorï¼ˆåŠ é€Ÿå™¨ï¼‰
- å¼€å¯å¹¶æ£€æµ‹æœåŠ¡

> k8s çš„ Pod éƒ½ä¾èµ– runtimeï¼Œæ‰€ä»¥è¿™ä¸€é˜¶æ®µè§£å†³ runtime çš„éƒ¨ç½²ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šå®‰è£… containerd/dockerï¼Œå¹¶è®©å…¶æ­£å¸¸è·‘èµ·æ¥ã€‚**

------

### âœ… **04.kube-master.yml â€” æ­å»º Master æ§åˆ¶å¹³é¢**

å¯¹ kube_master èŠ‚ç‚¹åšï¼š

- å®‰è£… kube-apiserver
- å®‰è£… kube-controller-manager
- å®‰è£… kube-scheduler
- æ¨é€ systemd æ–‡ä»¶
- å¯åŠ¨ä¸‰ä¸ªæ§åˆ¶å¹³é¢æœåŠ¡
- å®‰è£… kube-lbï¼ˆç”¨äº API é«˜å¯ç”¨çš„æœ¬åœ°è´Ÿè½½å‡è¡¡ï¼‰
- é…ç½® kube-nodeï¼ˆmaster åŒæ—¶ä¹Ÿå……å½“ nodeï¼‰

> è¿™é‡Œ k8s æ§åˆ¶é¢å…³é”®æœåŠ¡å¯åŠ¨åï¼Œå°±èƒ½ç”¨ kubectl æ“ä½œæ•´ä¸ªé›†ç¾¤ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šæŠŠ master ç»„ä»¶æ•´ä¸ªè£…ä¸Šã€å¯åŠ¨ã€è·‘èµ·æ¥ã€‚**

------

### âœ… **05.kube-node.yml â€” æ­å»º Node è®¡ç®—èŠ‚ç‚¹**

å¦‚æœèŠ‚ç‚¹ä¸æ˜¯ masterï¼Œåˆ™æ‰§è¡Œ kube-node è§’è‰²ï¼š

- é…ç½® kubelet
- é…ç½® kube-proxy
- é…ç½®è´Ÿè½½å‡è¡¡ï¼ˆkube-lbï¼‰
- æ‹‰å–å¿…éœ€é•œåƒ
- å¯åŠ¨ kubelet å’Œ kube-proxy

> Node èŠ‚ç‚¹æ­£å¼åŠ å…¥é›†ç¾¤å°±æ˜¯è¿™é‡Œå®Œæˆçš„ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šå®‰è£… kubelet / kube-proxyï¼Œä½¿å…¶åŠ å…¥é›†ç¾¤æˆä¸ºå·¥ä½œèŠ‚ç‚¹ã€‚**

------

### âœ… **06.network.yml â€” å®‰è£… CNI ç½‘ç»œæ’ä»¶ï¼ˆCalico / Flannel / Cilium ç­‰ï¼‰**

è¯¥é˜¶æ®µå¯¹æ‰€æœ‰èŠ‚ç‚¹ï¼ˆmaster + nodeï¼‰æ‰§è¡Œï¼š

- æ ¹æ®é…ç½®é€‰æ‹©å…¶ä¸­ä¸€ä¸ªç½‘ç»œæ’ä»¶
- åˆ†å‘é…ç½®æ–‡ä»¶/manifest
- åº”ç”¨ç½‘ç»œ yaml
- æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å˜æˆ Ready

å¯é€‰æ’ä»¶ï¼š

- calico
- flannel
- cilium
- kube-router
- kube-ovn

> å®‰è£…å®Œè¿™ä¸ªæ­¥éª¤ï¼ŒPod æ‰èƒ½è·¨ä¸»æœºé€šä¿¡ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šå®‰è£…å¹¶å¯ç”¨ CNI ç½‘ç»œæ’ä»¶ï¼Œè®© Pod ç½‘ç»œæ­£å¼å¯ç”¨ã€‚**

------

### âœ… **07.cluster-addon.yml â€” å®‰è£… Kubernetes æ‰©å±•ç»„ä»¶ Addons**

æœ¬æ­¥éª¤åœ¨ localhost ä¸Šæ‰§è¡Œï¼š

å®ƒä¼šå®‰è£… cluster å¿…å¤‡ addonï¼Œä¾‹å¦‚ï¼š

- CoreDNS
- Metrics-Server
- Dashboardï¼ˆå¯é€‰ï¼‰
- Ingress Controllerï¼ˆå¯é€‰ï¼‰
- StorageClass / CSIï¼ˆå¯é€‰ï¼‰
- æ—¥å¿—æ’ä»¶ç­‰

> kubeasz çš„é»˜è®¤ addon æ¯”è¾ƒé½å…¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å…³/å¼€ã€‚

âœ” **ä¸€å¥è¯æ€»ç»“ï¼šä¸ºé›†ç¾¤éƒ¨ç½²å¸¸ç”¨æ’ä»¶ï¼Œè®©é›†ç¾¤å…·å¤‡åŸºç¡€å¯è§‚æµ‹æ€§ã€DNSã€Ingressã€å­˜å‚¨ç­‰èƒ½åŠ›ã€‚**

------

# ğŸ§© **æ•´ä½“æµç¨‹æ€»è§ˆï¼ˆ7 æ­¥ï¼‰**

æˆ‘ç»™ä½ ä¸€ä¸ª**ç»“æ„åŒ–æµç¨‹å›¾**ï¼Œä½ ä¸€çœ‹å°±å®Œå…¨æ‡‚äº†ï¼š

------

## **1ï¼‰01.prepare.ymlï¼šå‡†å¤‡**

- åˆå§‹åŒ–æ‰€æœ‰èŠ‚ç‚¹
- ç”Ÿæˆ Kubernetes è¯ä¹¦
- åˆ†å‘ kubeconfig

------

## **2ï¼‰02.etcd.ymlï¼šéƒ¨ç½² etcd é›†ç¾¤**

- å®‰è£…
- é…ç½®
- å¯åŠ¨
- æ£€æŸ¥é›†ç¾¤çŠ¶æ€

------

## **3ï¼‰03.runtime.ymlï¼šéƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶**

- containerd / docker
- é…ç½® cgroup / é•œåƒåŠ é€Ÿ
- å¯åŠ¨æœåŠ¡

------

## **4ï¼‰04.kube-master.ymlï¼šéƒ¨ç½²æ§åˆ¶å¹³é¢**

- apiserver
- controller-manager
- scheduler
- å¯åŠ¨
- æœ¬åœ° lb
- master ä¹Ÿåš node åˆå§‹åŒ–

------

## **5ï¼‰05.kube-node.ymlï¼šéƒ¨ç½²å·¥ä½œèŠ‚ç‚¹**

- å®‰è£… kubelet
- å®‰è£… kube-proxy
- æœåŠ¡æ³¨å†ŒåŠ å…¥é›†ç¾¤

------

## **6ï¼‰06.network.ymlï¼šéƒ¨ç½² CNI ç½‘ç»œæ’ä»¶**

- Calico / Cilium / Flannelâ€¦
- Pod ç½‘ç»œå¼€å§‹è¿é€š

------

## **7ï¼‰07.cluster-addon.ymlï¼šéƒ¨ç½²é›†ç¾¤å¢å¼ºåŠŸèƒ½**

- CoreDNS
- Metrics
- Dashboard
- Ingress
- Storage

------



