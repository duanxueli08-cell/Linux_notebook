# windows

## Win10 LSTC 版本安装-微软商店安装包🍖

> 补充说明：Windows 10 LSTC 长期服务通道，专注于极致的稳定性和低维护，**默认不包含微软商店** 和许多内置应用。
>
> **21H1, 21H2, 22H2**：半年度频道版本，面向普通消费者和大多数企业，功能持续更新，**始终包含微软商店**。
>
> | 特性         | **LTSC 2019 / 2021**                                         | **21H1**                                            | **21H2**                                            | **22H2**                                                 |
> | :----------- | :----------------------------------------------------------- | :-------------------------------------------------- | :-------------------------------------------------- | :------------------------------------------------------- |
> | **目标用户** | 关键任务设备、工业控制系统、专用设备（如ATM、医疗设备）      | 普通消费者、办公用户、大多数企业                    | 普通消费者、办公用户、大多数企业                    | 普通消费者、办公用户、大多数企业                         |
> | **更新模式** | **5年主流支持 + 5年扩展支持**，**不**接收功能性更新，只接收安全更新 | **18个月服务周期**，定期接收新功能和安全更新        | **18个月服务周期**，定期接收新功能和安全更新        | **最终版本，支持至2025年10月14日**                       |
> | **微软商店** | **默认不包含**（但可手动安装）                               | **包含**                                            | **包含**                                            | **包含**                                                 |
> | **内置应用** | 极度精简，**无**Cortana、无Edge（经典版）、无天气、新闻等    | 完整，包含Cortana、Edge浏览器、相机、照片等全套应用 | 完整，包含Cortana、Edge浏览器、相机、照片等全套应用 | 完整，包含Cortana、Edge浏览器、相机、照片等全套应用      |
> | **新功能**   | **冻结**在发布时的状态，不添加新功能                         | 包含截至2021年5月的所有功能                         | 在21H1基础上小幅度更新，主要是安全性和质量改进      | 在21H2基础上小幅度更新，是21H2的一个启用包，核心功能一致 |
> | **系统要求** | 与对应基础版本一致                                           | 与早期版本如1909一致                                | 与21H1基本一致                                      | 与21H2基本一致                                           |
> | **基于内核** | LTSC 2019 基于 1809 LTSC 2021 基于 21H2                      | 基于 20H2                                           | 基于 21H1                                           | 基于 21H2                                                |

### 安装微软商店安装包的步骤

1.首先打开网页 https://store.rg-adguard.net/，在这个网页上可以下载到 Windows 应用商店的安装包。
2.在搜索框输入 https://www.microsoft.com/en-us/p/microsoft-store/9wzdncrfjbmp（这是 Windows 应用商店的网页地址），并选择Retail
3.下载如下资源包：

```powershell
Microsoft.NET.Native.Framework.2.2_2.2.29512.0_x64__8wekyb3d8bbwe.Appx
Microsoft.NET.Native.Runtime.1.7_1.7.27422.0_x64__8wekyb3d8bbwe.Appx
Microsoft.UI.Xaml.2.7_7.2208.15002.0_x64__8wekyb3d8bbwe.Appx
Microsoft.VCLibs.140.00_14.0.30704.0_x64__8wekyb3d8bbwe.Appx
Microsoft.WindowsStore_22207.1401.1.0_neutral___8wekyb3d8bbwe.Msixbundle
```

> 除了 Windows 应用商店的安装包外，还有其他的安装包，这些安装包是依赖包
>
> 由于 Microsoft Store 应用依赖于 .NET Framework、.NET Runtime、Microsoft.UI.Xaml 和 VC Libs，因此请下载列出的每个项的最新包。
>
> - 有些包是 Appx 后缀，也有 Msixbundle
> - 请忽略 BlockMap 后缀的文件
> - 注意选择最新版本
> - 注意选择正确的构架（一般是 `x64`）



4.以**管理员权限**打开 PowerShell ，使用如下指令一次安装

```powershell
Add-AppxPackage -Path "E:\Microsoft.NET.Native.Framework.2.2_2.2.29512.0_x64__8wekyb3d8bbwe.Appx"

Add-AppxPackage -Path "E:\Microsoft.NET.Native.Runtime.2.2_2.2.28604.0_x64__8wekyb3d8bbwe.Appx"

Add-AppxPackage -Path "E:\Microsoft.UI.Xaml.2.8_8.2501.31001.0_x64__8wekyb3d8bbwe.Appx"

Add-AppxPackage -Path "E:\Microsoft.VCLibs.140.00_14.0.33519.0_x64__8wekyb3d8bbwe.Appx"

Add-AppxPackage -Path "E:\Microsoft.WindowsStore_22508.1401.8.0_neutral_~_8wekyb3d8bbwe.Msixbundle"
```

> 如果您收到错误，请跳过该包。这很可能是因为包或依赖项已安装，并且当前正在由其他应用程序使用。`Deployment failed with HRESULT: 0x80073D02`

此外，还可以运行以下命令来检查是否已安装应用包：

```powershell
get-appxpackage | sort-object -Property PackageFullName | select packagefullname | out-gridview
```

如果已安装（相同版本的）包，则无需再次安装。



5.若要验证 Microsoft Store 应用信息，请打开 PowerShell（管理员）窗口并运行以下命令：

```powershell
Get-AppxPackage Microsoft.WindowsStore
```

```powershell
Name              : Microsoft.WindowsStore
Publisher         : CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US
Architecture      : X64
ResourceId        :
Version           : 22508.1401.8.0
PackageFullName   : Microsoft.WindowsStore_22508.1401.8.0_x64__8wekyb3d8bbwe
InstallLocation   : C:\Program Files\WindowsApps\Microsoft.WindowsStore_22508.1401.8.0_x64__8wekyb3d8bbwe
IsFramework       : False
PackageFamilyName : Microsoft.WindowsStore_8wekyb3d8bbwe
PublisherId       : 8wekyb3d8bbwe
IsResourcePackage : False
IsBundle          : False
IsDevelopmentMode : False
NonRemovable      : False
Dependencies      : {Microsoft.NET.Native.Framework.2.2_2.2.29512.0_x64__8wekyb3d8bbwe, Microsoft.NET.Native.Runtime.2.
                    2_2.2.28604.0_x64__8wekyb3d8bbwe, Microsoft.VCLibs.140.00.UWPDesktop_14.0.33728.0_x64__8wekyb3d8bbw
                    e, Microsoft.UI.Xaml.2.8_8.2501.31001.0_x64__8wekyb3d8bbwe...}
IsPartiallyStaged : False
SignatureKind     : Store
Status            : Ok
```

> 你将看到 Microsoft Store 应用及其依赖项已完全安装。
>
> *本文适用于 Windows 10 和 Windows 11。*



# Windows10系统封装

## 封装涉及到的工具

```powershell
Anyburn						（必选，也可以是其他的替代品）
VMware Workstation Pro		（必选，也可以是其他的替代品）
Optimizer-16.7				（可选）
Dism++10.1.1002.1B			（可选）
一个pe系统，一个目标修改系统
```



## 封装涉及到的指令

### 封装命令

```powershell
slmgr /upk          # 卸载产品密钥(可选)
slmgr /cpky         # 清除注册表中的密钥（可选）

进入sysprep.exe文件所在的目录进行封装
cd C:\Windows\System32\Sysprep
sysprep.exe /generalize /oobe /shutdown /unattend:C:\Windows\System32\Sysprep\autounattend.xml
```

### 导出镜像

```powershell
dism /capture-image /imagefile:E:\install.wim /capturedir:D:\ /name:"Windows10_Custom"
```



**如何定义EI.CFG文件，需要查看映像文件版本信息：**

dism /get-wiminfo /wimfile:F:\系统封装教程\install.wim

>F:\系统封装教程\install.wim 这个是存放install.wim文件的路径，根据实际情况更改。

dism /get-wiminfo /wimfile:F:\系统封装教程\install.wim /index:1

> index:1 这个是索引值，根据上面的指令查看索引值。

> **继续使用 IoTEnterpriseS 映像**并且想在安装过程**跳过输入产品密钥**的提示。

------

### 方法 A — 用 **autounattend.xml**（推荐，最可靠）

把一个自动应答文件 `autounattend.xml` 放在安装介质（USB/ISO）的根目录，Windows Setup 会在启动时自动读取并按配置跳过提示。

**最小可用示例**（把整个文件保存为 `autounattend.xml`）：

```xml
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend">
  <!-- 在 windowsPE / specialize 两个阶段配置 -->
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64"
               publicKeyToken="31bf3856ad364e35" language="neutral"
               versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <UserData>
        <AcceptEula>true</AcceptEula>
        <!-- 留空 ProductKey 并将 WillShowUI 设为 Never，避免显示输入 UI -->
        <ProductKey>
          <WillShowUI>Never</WillShowUI>
        </ProductKey>
      </UserData>
    </component>
  </settings>

  <settings pass="specialize">
    <component name="Microsoft-Windows-Security-SPP-UX" processorArchitecture="amd64"
               publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS"
               xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <!-- 跳过自动激活（仅安装阶段跳过提示，激活仍需后来处理） -->
      <SkipAutoActivation>true</SkipAutoActivation>
    </component>
  </settings>
</unattend>
```

要点／优点：

- Windows Setup 启动后会读取并跳过“输入密钥”的界面（WillShowUI 控制是否显示 UI）。文档说明可用性：Microsoft Docs（WillShowUI／ProductKey）。([Microsoft Learn](https://learn.microsoft.com/en-us/windows-hardware/customize/desktop/unattend/microsoft-windows-setup-userdata-productkey-willshowui?utm_source=chatgpt.com))
- 可以在 `specialize` 阶段再做更多自定义（如注入密钥、设置主机名等）。
- 不会在安装时把非法密钥写入镜像；只是避免交互提示。安装后需用正确密钥激活。

注意：

- 在 Windows 安装过程中，**必须命名为 `autounattend.xml`**，而不能使用 `unattend.xml` 或其他文件名。这个文件名有特定的要求和作用。
- **`autounattend.xml`** 是 Windows 安装过程中自动读取的文件名，安装程序会在安装开始时自动检测到它，并根据其中的配置来进行自动化安装。
- 文件名 **`unattend.xml`** 通常是用在 Windows 部署服务（WDS）、MDT（Microsoft Deployment Toolkit）等环境中的，通常不是在标准安装介质（USB 或 ISO）中自动加载的名称。
- **`unattend.xml`**：通常用于批量部署环境（如 WDS 或 MDT），并不是自动执行的文件，而是需要在部署过程中特别调用或指定。

### 结论：

- **对于普通的 Windows 安装 ISO 或 USB 启动介质**，必须使用 **`autounattend.xml`**，否则文件中的配置不会被自动读取。
- **如果你只想跳过产品密钥输入并自动化安装**，确保命名文件为 **`autounattend.xml`**，并将其放到安装介质的根目录。

------

### 方法 B — 用 `ei.cfg` / `PID.txt` 控制（简单、快速）

将下面的文件放到 ISO 的 `sources` 目录下可以影响安装器对版本和密钥的处理。

**ei.cfg**（指定版本和频道）示例（放 `sources\ei.cfg`）：

```ini
[EditionID]
IoTEnterpriseS

[Channel]
Retail

[VL]
0
```

**PID.txt**（放 `sources\PID.txt`）可以预先填写产品密钥（可选）。如果你不填任何 key，某些安装器/版本会允许跳过输入，但行为不一。MS 文档说明了 ei.cfg 与 PID.txt 的用途。([Microsoft Learn](https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-setup-edition-configuration-and-product-id-files--eicfg-and-pidtxt?view=windows-11&utm_source=chatgpt.com))

要点／优点：

- 适合只想控制“默认安装版本 / 跳过选择版本”的场景。
- 简单、无需 XML。

注意：

- 新版安装器（例如某些 24H2 installer）对 ei.cfg 的处理有所变化，可能不会按预期工作 —— 若遇到新版安装器不尊重 ei.cfg，请改用 autounattend。([Reddit](https://www.reddit.com/r/Operatingsystems/comments/1fy2ae0/new_24h2_windows_os_installer_wont_let_you_choose/?utm_source=chatgpt.com))

------

> 正确的 `PID.txt` 配置方式

> **PID.txt** 文件只能包含你在安装过程中使用的 **产品密钥**，比如：

```
[PID]
ProductKey=KBN8V-HFGQ4-MGXVD-347P6-PDQGT
```

这样配置后，Windows 安装程序会在安装过程中读取 **`PID.txt`** 中的产品密钥并自动进行安装，而不会要求用户手动输入密钥。

------

- **在安装时推荐将方案一与方案二并行使用，两个不是非此即彼的关系！而且我在安装时还是需要输入产品密钥，说明pid与xml并没有生效！**
- **补充：pid没有生效不清楚，但是xml文件应该是放错位置了！**
- **目录结构应该是这样的：**

```
USB或ISO的根目录/
├── autounattend.xml  ← 您的应答文件放在这里
├── boot/
├── efi/
├── sources/
├── bootmgr
└── ...其他安装文件
```

- **而在vmware中安装时，我放置在了C:\Windows\System32\Sysprep目录下，导致文件失效！**
- **之前一直存在的问题 “安装的时候显示输入的产品密钥与可用于安装的任何可用windows映像都不匹配” 得到解决，我估计是EI.CFG文件生效了！**





