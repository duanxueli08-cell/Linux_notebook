# 业务场景与基础设施详单

#### 1. 基础环境概览 (Infrastructure Overview)

- **云厂商：** 阿里云 (华东1-杭州节点) + 少量本地 IDC (用于冷备/测试)。
- **服务器总数：** **62台** (ECS 云服务器)。
- **操作系统：** CentOS 7.9 (内核升级至 4.19+ 以支持 K8s 更好的性能)。
- **网络架构：** VPC 专有网络，划分 3 个交换机 (vSwitch) 实现网络隔离：
  - **DMZ 区 (公网区)：** 放 Nginx、堡垒机。
  - **App 区 (应用区)：** 放 K8s 集群。
  - **Data 区 (数据区)：** 放 MySQL、Redis、ES (禁止公网访问)。

#### 2. 服务器角色分配 (Server Roles) —— *这是最显功力的地方*

我们需要把这 **62台** 机器合理分配，面试官问起来，你心里要有这张表：

| **角色分组**      | **数量** | **配置 (CPU/Mem)** | **部署内容/备注**                                         |
| ----------------- | -------- | ------------------ | --------------------------------------------------------- |
| **K8s Master**    | 3台      | 4C 8G              | API Server, Controller, Scheduler, Etcd (堆叠部署)        |
| **K8s Worker**    | 9台      | 8C 16G             | **核心生产节点**，运行 Java/Go 微服务、Ingress Controller |
| **MySQL (Prod)**  | 2台      | 8C 32G             | **一主一从 (GTID复制)**，SSD 云盘，承载订单/会员核心数据  |
| **Redis (Prod)**  | 6台      | 4C 8G              | **Redis Cluster 集群** (3主3从)，用于缓存高频商品/Token   |
| **Nginx/LB**      | 2台      | 2C 4G              | 传统负载均衡 (Keepalived+Nginx)，作为 K8s 外部的入口      |
| **Elasticsearch** | 3台      | 8C 16G             | **ES 集群**，存储生产环境业务日志 (独立部署，不进K8s)     |
| **DevOps 组**     | 4台      | 4C 8G              | GitLab(1台), Jenkins(1台), Harbor(1台), Nexus(1台)        |
| **监控组**        | 2台      | 4C 8G              | Prometheus + Grafana + Alertmanager (独立部署)            |
| **测试环境**      | 15台     | 混配               | 测试用 K8s 集群 (单Master)、测试数据库、开发联调机        |
| **运维支撑**      | 2台      | 2C 4G              | Jumpserver 堡垒机(1台), VPN/NTP/DNS 服务(1台)             |
| **预留/备用**     | 14台     | -                  | 弹性伸缩预留、大数据分析跑批任务、冷备机器                |
| **总计**          | **62台** |                    |                                                           |

#### 3. 关键软件版本 (Software Stack) —— *防止被问倒*

- **Kubernetes:** v1.23.6 (稳定版，不要说最新版，企业求稳)
- **Docker:** 20.10.x
- **Network CNI:** Calico (BGP模式，性能好)
- **MySQL:** 5.7.35 (最经典版本，不要盲目说 8.0 除非你熟)
- **Redis:** 6.0.x (支持多线程)
- **Nginx:** 1.20.1 (Stable Version)
- **Jenkins:** 2.3xx (LTS 长期支持版)
- **Java (业务):** JDK 1.8 和 JDK 11 并存

#### 4. 流量走向 (Traffic Flow) —— *面试必问*

当一个用户在“鲜丰水果”门店下单时，流量是这么走的：

1. **公网入口：** 用户手机 App -> 阿里云 SLB (4层负载)。
2. **集群入口：** SLB -> K8s Ingress Controller (部署在 Worker 节点上的 Nginx)。
3. **服务路由：** Ingress -> Service (ClusterIP) -> **订单微服务 Pod**。
4. **数据交互：**
   - Pod -> **Redis Cluster** (校验库存/Token)。
   - Pod -> **MySQL Master** (写入订单数据)。
5. **日志流向：** Pod (打印日志到 stdout) -> Filebeat (DaemonSet) -> Kafka/Logstash -> ES 集群。

------

### 💡 针对此场景的面试防御 (Q&A)

**Q1: 你们为什么 K8s Master 是 3 台？Etcd 是怎么部署的？**

- **答：** “为了高可用。如果只有 1 台 Master，挂了集群就失控了。我们采用的是 **堆叠式 Etcd**，也就是 Etcd 跑在这 3 台 Master 节点上，数据互相同步。坏掉一台，另外两台还能通过 Raft 协议选举，保证集群正常。”

**Q2: 你们 Worker 节点配置是 8C16G，一般跑多少个 Pod？**

- **答：** “我们一般按资源利用率 70% 规划。Java 应用比较吃内存，一个微服务大概给 2G-4G 内存。一台 16G 的机器，刨去系统开销和 Kubelet 预留，大概能跑 **4-6 个 Java Pod**，外加一些 Filebeat 之类的 Agent。9 台 Worker 足够支撑我们需要跑的 40 多个微服务副本了。”

**Q3: 为什么 MySQL 和 Redis 不进 K8s？**

- **答：** “**求稳。** K8s 的强项是编排无状态应用（随便重启）。但数据库是有状态的，如果在 K8s 里 Pod 漂移了，涉及数据同步、持久化存储（PV/PVC）的挂载解挂，风险比较大。对于我们这种 60台规模的公司，直接部署在 ECS 或者用 RDS 最稳妥，出了问题 DBA 好排查。”

**Q4: 你们的测试环境和生产环境是怎么隔离的？**

- **答：** “完全隔离。
  - **网络隔离：** 生产环境和测试环境在阿里云上属于不同的 VPC。
  - **K8s 隔离：** 生产环境是那套 12 节点的集群；测试环境有另一套小的 K8s 集群（1 Master + 3 Worker）。
  - **发布隔离：** Jenkins 里有 pipeline 权限控制，只有运维经理有权限点击 Deploy to Prod。”

------

### 🧠 记忆重点

老哥，这个表不需要你完全死记硬背每一个数字，但你要记住几个核心比例：

1. **1:3 比例：** 3个 Master，9个 Worker（这是黄金比例）。
2. **Java 吃内存：** 所以 Worker 节点内存要稍微大点（16G 或 32G）。
3. **一半一半：** 大约一半机器给 K8s，另一半机器给数据库、中间件、测试环境。这样说最合理。

现在这个**“物理级”**的业务场景够具体了吗？拿着这个表，面试官问到底层硬件规划，你也能对答如流！





