### 架构图 (业务场景框架)

请死记这张图的布局。如果面试官让你画，你就按这个层次画。

**核心逻辑：** 混合架构。无状态业务（Java/Nginx）跑在 K8s 里，有状态数据（MySQL/Redis）和管理工具（Jenkins/ELK）跑在独立虚拟机上。

#### 🏗️ 架构分层示意图

代码段

```
graph TD
    User((用户/客户端)) --> CDN[CDN 加速]
    CDN --> SLB[阿里云 SLB 负载均衡]
    
    subgraph "Kubernetes 生产集群 (12节点)"
        SLB --> Ingress[Ingress-Nginx (七层入口)]
        Ingress --> SvcWeb[Service: 前端 Nginx]
        Ingress --> SvcApp[Service: 核心业务 API]
        
        subgraph "无状态应用层 (Pod)"
            PodWeb[前端容器 (Vue/React)]
            PodOrder[订单服务 (Java)]
            PodUser[用户服务 (Java)]
            PodProduct[商品服务 (Java)]
        end
        
        SvcWeb --> PodWeb
        SvcApp --> PodOrder & PodUser & PodProduct
        
        PodOrder -.-> PodUser
    end
    
    subgraph "基础设施与数据层 (独立 ECS/RDS)"
        PodOrder --> DB[(MySQL 主从/RDS)]
        PodOrder --> Redis[(Redis Cluster)]
        PodOrder --> NFS[NFS 共享存储 (存静态资源)]
    end
    
    subgraph "运维管理区 (独立虚拟机)"
        Dev[开发人员] --> GitLab[GitLab 代码库]
        GitLab --> Jenkins[Jenkins CI/CD]
        Jenkins --> Harbor[Harbor 镜像仓库]
        Jenkins --"Deploy"--> Ingress
        
        Prometheus[Prometheus 监控] --"Pull"--> PodOrder & DB & Redis
        ELK[ELK 日志栈] --"Filebeat采集"--> PodOrder
    end
```

#### 🗣️ 配合架构图的“画图解说词” (面试必背)

> “面试官您好，我们公司的架构主要是基于**阿里云 ECS 自建的混合架构**。
>
> 1. **流量入口：** 用户请求经过 CDN 加速后，到达阿里云的 **SLB** 负载均衡。
> 2. **应用层（K8s）：** SLB 转发给 K8s 集群的 **Ingress-Nginx** 入口。我们的核心业务（像订单、用户、商品中心）都是微服务化的，运行在 K8s 的 Pod 里（大约 40 多个微服务）。
> 3. **数据层（独立）：** 为了稳，我们的数据库 **MySQL** 和缓存 **Redis** 没有进 K8s，而是部署在独立的 ECS 或者直接用的 RDS，保证数据安全。
> 4. **运维支撑：** 我们有独立的运维管理网段，部署了 **Jenkins** 做发布，**GitLab** 管代码，还有 **Prometheus** 做监控。日志方面，我们在 K8s 节点上跑 **Filebeat**，把日志收集到独立的 **ES** 集群里分析。”

------

### 一、 架构定义 (Architecture Definition)

架构名称： 基于“计算与存储分离”的混合部署架构 (Compute-Storage Separation Architecture)

基础设施： 阿里云 ECS (VPC 专有网络) + 少量 IDC 冷备

核心逻辑：

- **计算（无状态）：** 业务应用全面容器化，托管于 **Kubernetes** 集群，利用其弹性调度能力。
- **存储与管理（有状态）：** 数据库、中间件及运维管理工具部署于 **独立虚拟机 (ECS)**，保障数据持久性与IO性能。

------

### 二、 架构分层详解 (System Topology)

我们将整个架构自上而下分为 **四层**：

#### 1. 接入层 (Access Layer)

- **功能：** 流量入口与安全防御。
- **组件：**
  - **CDN：** 静态资源加速（图片、JS/CSS）。
  - **SLB (Server Load Balancer)：** 阿里云 4 层负载均衡，作为公网唯一入口。
  - **Ingress-Nginx：** K8s 集群的 7 层网关，负责域名路由转发、SSL 卸载。

#### 2. 计算层 (Compute Layer - K8s Cluster)

- **功能：** 承载核心微服务业务（SaaS 业务逻辑）。
- **规模：** 12 节点生产集群 (3 Master + 9 Worker)。
- **运行对象：**
  - **无状态服务：** 订单、用户、商品等 Java 微服务 (Deployment)。
  - **前端服务：** Vue/React 静态页面容器 (Nginx Pod)。
  - **自愈机制：** 依赖 K8s 的 ReplicaSet 保证副本数，LivenessProbe 负责故障自动重启。

#### 3. 数据层 (Data Layer - Independent VMs)

- **功能：** 数据持久化与缓存。
- **部署方式：** 独立 ECS 部署，**不入 K8s**。
- **组件：**
  - **MySQL：** 一主一从 (GTID 模式)，负责核心交易数据。
  - **Redis：** Cluster 集群 (3主3从)，负责热点缓存与分布式锁。
  - **NFS/OSS：** 负责非结构化数据（如合同文件、日志备份）存储。

#### 4. 运维管理层 (Management Layer - Out-of-Band)

- **功能：** 这里的工具是“救生艇”，必须独立于业务集群。
- **组件：**
  - **CI/CD：** Jenkins + GitLab + Harbor (独立部署，确保 K8s 挂了也能发布修复包)。
  - **可观测性：** Prometheus + Grafana (监控)；ELK Stack (日志，ES 独立部署)。
  - **安全：** Jumpserver 堡垒机。

------

### 三、 架构优缺点深度分析 (Pros & Cons)

面试官问你：“为什么要这么设计？”或者“这套架构有什么缺点？”时，请抛出以下分析。这能显示你**客观、理性**的技术视角。

#### ✅ 优点 (Pros) - 为什么要这么做？

1. **极致的稳定性 (Stability First)：**
   - **爆炸半径隔离：** 如果 K8s 集群因为 CNI 插件故障或证书过期崩了，数据库和运维平台依然存活。运维人员可以通过 Jenkins 和堡垒机进行修复，数据也不会丢失。
   - **IO 性能保障：** 数据库直接运行在 ECS 本地 SSD 上，避免了 K8s 网络存储插件 (CSI) 带来的 IO 损耗和延迟。
2. **扬长避短 (Best Practice)：**
   - 利用 K8s 管理“易变”的业务容器（版本更新快、扩缩容频繁）。
   - 利用虚拟机管理“稳定”的数据库（IP 固定、配置变更少、极度依赖磁盘）。
3. **运维成本可控 (Cost Effective)：**
   - 对于 60 台机器的团队，维护一套 K8s 内的高可用 MySQL (StatefulSet + Operator) 技术门槛极高。使用虚拟机部署，招聘普通的 Linux 运维或 DBA 就能维护，降低了人才成本。

#### ❌ 缺点 (Cons) - 我们怎么应对的？

1. **资源利用率略低：**
   - *问题：* 数据库独占 ECS，如果业务低峰期，数据库 CPU 闲置，无法像 K8s 那样被其他应用共享。
   - *应对：* 我们通过云厂商的“弹性升降配”来解决，或者在数据库机器上跑一些低优先级的离线备份任务。
2. **环境割裂：**
   - *问题：* 运维需要同时维护两套技术栈（K8s 的 YAML 和虚拟机的 Ansible/Shell）。
   - *应对：* 我们通过 Jenkins 流水线将两者串联，通过 Ansible 统一管理所有虚拟机的基础配置（如内核参数、安全基线），尽量标准化。
3. **网络跳跃：**
   - *问题：* K8s Pod 访问外部 MySQL 需要经过 overlay 网络到 host 网络，理论上有一点点性能损耗。
   - *应对：* 实际上在阿里云 VPC 内网下，这个损耗几乎可以忽略不计（微秒级），对于我们的 SaaS 零售业务来说完全在可接受范围内。

------

### 四、 面试陈述话术 (Summary for Interview)

**当面试官问：“请介绍一下你们的系统架构。” 你可以这样总结：**

> “我们的架构设计原则是**‘计算与存储分离，管理与业务解耦’**。
>
> 整体采用混合部署模式：
>
> 核心的无状态业务（Java/Web）全部跑在 Kubernetes 集群中，利用 K8s 的弹性调度和自愈能力，解决业务频繁迭代和扩容的问题。
>
> 而有状态的数据库（MySQL/Redis）以及运维管理工具（Jenkins/ELK），为了保障数据安全和 I/O 性能，我们坚持部署在独立的 ECS 虚拟机上，不入 K8s。
>
> 这种架构最大的好处是**稳**。即使 K8s 集群出现极端故障，我们的数据层和运维救援通道依然是完好的，能够将风险控制在最小范围。虽然在资源利用率上不如全容器化高，但对于我们目前 60 台服务器的规模来说，这是**维护成本最低且最安全**的方案。”

------





### 面试防御话术：面试官问你“为什么”

如果面试官问：“现在 K8s 这么火，Operator 也很成熟了，你们为什么不把 MySQL 和 Redis 也放进 K8s 里？”

**请用这套话术进行降维打击：**

> **话术：** “我们也评估过把数据放进 K8s。虽然技术上是可行的（比如用 Helm 部署或者 Operator），但结合我们公司的业务规模（60+台）和运维人力，我们认为**数据安全**和**IO性能**是第一位的。
>
> 1. **IO 性能瓶颈：** 数据库在 K8s 里通常需要走 Ceph 或者云盘的 CSI 插件，网络存储的 IO 往往不如直接在 ECS 上挂载本地 SSD 快和稳定。
> 2. **故障隔离：** 我们希望把‘计算’和‘存储’分离。如果 K8s 集群出现因为资源耗尽导致的雪崩，我们不希望影响到数据库层。这样即使 K8s 崩了，数据还是活着的，重建业务很快。
> 3. **维护成本：** 维护 K8s 内的 StatefulSet 需要很深的技术功底，而维护独立虚拟机上的 MySQL，我们有成熟的脚本和现成的 DBA 经验，**求稳**是我们架构选型的首要原则。”

------

### 这种架构如何保证高可用？

你提到的“依靠 K8s 的调度机制和自愈能力”主要保的是**业务层**。 那整体的高可用是怎么串联的？

1. **业务层 (K8s)：**
   - **Pod 挂了：** K8s 的 `ReplicaSet` 会自动检测副本数不足，立马拉起新 Pod（自愈）。
   - **节点挂了：** K8s 的 `Scheduler` 会把该节点上的 Pod 重新调度到健康的节点上（漂移）。
2. **数据层 (VM)：**
   - **MySQL：** 靠 **MHA** 或者 **主从复制**。主库挂了，脚本/中间件自动切换到从库。
   - **Redis：** 靠 **Sentinel (哨兵)** 或 **Cluster**。节点挂了自动选举新 Master。
   - *注意：* 这部分不由 K8s 管，由你配置在 VM 上的脚本管。

